
# 七牛云证书自动续期脚本

acme.sh + 阿里云 DNS API（全自动，推荐）
acme.sh 支持阿里云 DNS API 自动添加/删除 TXT 记录，实现全自动申请和续期。

需要的信息：

阿里云 AccessKey ID 和 AccessKey Secret（用于操作 DNS 记录）
步骤：

在服务器安装 acme.sh
配置阿里云 DNS API 密钥
用 DNS 验证申请 qiniu.biomed168.com 的证书
证书自动续期 + 挂钩更新七牛云脚本

```sh
#!/bin/bash
# ============================================================
# 七牛云 SSL 证书自动更新脚本
# 用法: ./qiniu_ssl_renew.sh <cdn域名>
# 示例: ./qiniu_ssl_renew.sh qiniu.biomed168.com
# 定时任务: 0 3 * * * /path/to/qiniu_ssl_renew.sh qiniu.biomed168.com
# ============================================================

set -euo pipefail

# -------------------- 配置 --------------------
# 从系统环境变量读取，不在脚本中硬编码密钥
CERT_BASE_DIR="/opt/qiniu_ssl"
LOG_DIR="/var/log/qiniu_ssl"
# -------------------- 配置结束 --------------------

# 检查七牛云密钥环境变量
if [ -z "${QINIU_ACCESS_KEY:-}" ]; then
    echo "[ERROR] 环境变量 QINIU_ACCESS_KEY 未设置" >&2
    exit 1
fi
if [ -z "${QINIU_SECRET_KEY:-}" ]; then
    echo "[ERROR] 环境变量 QINIU_SECRET_KEY 未设置" >&2
    exit 1
fi

# 参数检查
if [ $# -lt 1 ]; then
    echo "用法: $0 <cdn域名>"
    echo "示例: $0 qiniu.biomed168.com"
    exit 1
fi

CERT_DOMAIN="$1"
DATE_STR=$(date +"%Y%m%d")
DATETIME_STR=$(date +"%Y-%m-%d %H:%M:%S")

# 确保日志目录存在
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/ssl_renew_${CERT_DOMAIN}_${DATE_STR}.log"

# 日志函数
log() {
    local msg="[$(date +"%Y-%m-%d %H:%M:%S")] $1"
    echo "$msg" | tee -a "$LOG_FILE"
}

log_error() {
    local msg="[$(date +"%Y-%m-%d %H:%M:%S")] [ERROR] $1"
    echo "$msg" | tee -a "$LOG_FILE" >&2
}

# 生成七牛云管理凭证 (QBox Token)
# 参数: $1=HTTP方法, $2=路径, $3=请求体(可选)
generate_qbox_token() {
    local method="$1"
    local path="$2"
    local body="${3:-}"

    # 构建签名字符串
    local signing_str="${method} ${path}\nHost: api.qiniu.com\nContent-Type: application/json\n\n${body}"

    # HMAC-SHA1 签名 + URL-safe Base64
    local sign=$(printf "%b" "$signing_str" | openssl dgst -sha1 -hmac "$QINIU_SECRET_KEY" -binary | base64 | tr '+/' '-_')

    echo "${QINIU_ACCESS_KEY}:${sign}"
}

# ==================== 开始执行 ====================
log "=========================================="
log "七牛云 SSL 证书更新开始"
log "域名: $CERT_DOMAIN"
log "日期: $DATETIME_STR"
log "=========================================="

# 1. 检查证书文件
CERT_DIR="${CERT_BASE_DIR}/${CERT_DOMAIN}"
PRIVKEY_FILE="${CERT_DIR}/privkey.pem"
FULLCHAIN_FILE="${CERT_DIR}/fullchain.pem"

if [ ! -f "$PRIVKEY_FILE" ]; then
    log_error "私钥文件不存在: $PRIVKEY_FILE"
    exit 1
fi

if [ ! -f "$FULLCHAIN_FILE" ]; then
    log_error "证书链文件不存在: $FULLCHAIN_FILE"
    exit 1
fi

log "证书文件检查通过"

# 2. 读取证书内容
PRIVKEY_CONTENT=$(cat "$PRIVKEY_FILE")
FULLCHAIN_CONTENT=$(cat "$FULLCHAIN_FILE")
CERT_NAME="${CERT_DOMAIN}-letsencrypt-${DATE_STR}"

log "证书名称: $CERT_NAME"

# 3. 构建上传证书的 JSON 请求体
# 使用 python3/jq 构建 JSON 以正确转义换行符
if command -v python3 &>/dev/null; then
    UPLOAD_BODY=$(python3 -c "
import json, sys
pri = open('$PRIVKEY_FILE').read()
ca = open('$FULLCHAIN_FILE').read()
print(json.dumps({
    'name': '$CERT_NAME',
    'common_name': '$CERT_DOMAIN',
    'pri': pri,
    'ca': ca
}))
")
elif command -v jq &>/dev/null; then
    UPLOAD_BODY=$(jq -n \
        --arg name "$CERT_NAME" \
        --arg cn "$CERT_DOMAIN" \
        --arg pri "$PRIVKEY_CONTENT" \
        --arg ca "$FULLCHAIN_CONTENT" \
        '{name: $name, common_name: $cn, pri: $pri, ca: $ca}')
else
    log_error "需要 python3 或 jq 来构建 JSON 请求体"
    exit 1
fi

# 4. 上传证书到七牛云
log "正在上传证书到七牛云..."

UPLOAD_TOKEN=$(generate_qbox_token "POST" "/sslcert" "$UPLOAD_BODY")
UPLOAD_RESPONSE=$(curl -s -X POST "http://api.qiniu.com/sslcert" \
    -H "Authorization: QBox ${UPLOAD_TOKEN}" \
    -H "Content-Type: application/json" \
    -d "$UPLOAD_BODY")

log "上传响应: $UPLOAD_RESPONSE"

# 提取 certID
CERT_ID=$(echo "$UPLOAD_RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('certID',''))" 2>/dev/null || echo "")

if [ -z "$CERT_ID" ]; then
    log_error "证书上传失败！无法获取 certID"
    log_error "响应内容: $UPLOAD_RESPONSE"
    exit 1
fi

log "证书上传成功! certID: $CERT_ID"

# 5. 修改 CDN HTTPS 证书配置
log "正在更新 CDN HTTPS 配置..."

HTTPSCONF_PATH="/domain/${CERT_DOMAIN}/httpsconf"
HTTPSCONF_BODY=$(python3 -c "
import json
print(json.dumps({
    'certId': '$CERT_ID',
    'forceHttps': False,
    'http2Enable': True
}))
" 2>/dev/null || echo "{\"certId\":\"$CERT_ID\",\"forceHttps\":false,\"http2Enable\":true}")

HTTPSCONF_TOKEN=$(generate_qbox_token "PUT" "$HTTPSCONF_PATH" "$HTTPSCONF_BODY")
HTTPSCONF_RESPONSE=$(curl -s -X PUT "http://api.qiniu.com${HTTPSCONF_PATH}" \
    -H "Authorization: QBox ${HTTPSCONF_TOKEN}" \
    -H "Content-Type: application/json" \
    -d "$HTTPSCONF_BODY")

log "CDN HTTPS 配置响应: $HTTPSCONF_RESPONSE"

# 6. 检查结果
if echo "$HTTPSCONF_RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); sys.exit(0 if d.get('error') is None or d.get('error')=='' else 1)" 2>/dev/null; then
    log "=========================================="
    log "七牛云 CDN SSL 证书更新完成!"
    log "域名: $CERT_DOMAIN"
    log "证书ID: $CERT_ID"
    log "=========================================="
else
    log_error "CDN HTTPS 配置更新可能失败"
    log_error "响应: $HTTPSCONF_RESPONSE"
    exit 1
fi

# 7. 清理旧日志 (保留30天)
find "$LOG_DIR" -name "ssl_renew_*.log" -mtime +30 -delete 2>/dev/null || true

log "旧日志清理完成 (保留30天)"
log "日志文件: $LOG_FILE"

```