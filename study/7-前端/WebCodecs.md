# WebCodecs

Web Codecs是浏览器提供的一套音视频编解码的API。相比较于我们自行编写的wasm进行软编软解，Web Codecs可以利用浏览器自带的FFmpeg，其执行效率是高于webassembly的，而且可以充分利用GPU。但其缺点就是编解码的兼容性较差，对于浏览器未支持或者未开放的编解码格式，都无法进行处理。关于WebCodecs的使用其实非常简单，有很多文章可以参考，基本上就是配置一个编码器（或者解码器），喂给它视频帧（或者编码块），得到编码块（或者视频帧）。关于这部分的基础API如何使用，建议直接看[官方文档](https://developer.mozilla.org/en-US/docs/Web/API/WebCodecs_API)。

## 为什么用`WebCodecs`而不用`ffmpeg`

ffmpeg不易将中间产物进行预览。如果将预览和导出的编辑分开，又不能确保所见即所得.在浏览器提供解封装能力

## 编码与封装

我们拿到一个视频，其后缀名一般决定了其封装格式，如mp4、webm、flv，它决定的仅仅是音视频格式如何组装到一起。对视频进行解封装后就能拿到其编码格式和编码数据，常见视频编码格式有H.264、H.265、VP8、VP9等，对编码数据进行解码后，就可以得到原始的视频帧数据。以上是播放过程，需要进行解封装和解码。如果要将视频导出，则需要进行相反的操作，先得到原始的视频帧数据，再进行编码，最后进行封装。

## I帧、P帧和B帧

- **I帧**：被称为关键帧，在解码时，一个I帧就可以得到一个完整的视频帧。
- **P帧**：前向参考帧，它需要在I帧的基础上进行解码，才能得到视频帧，单独对P帧无法完成解码。
- **B帧**：双向预测编码帧，它不仅要得到前面的解码帧，还要得到后面的解码帧，单独的B帧无法单独完成解码，在存在B帧的情况下，帧的解码顺序与播放顺序是不一致的。

## GOP

两个I帧之间，被称为一个GOP，是一组连续的画面。通常一个GOP是一个解码单元。

## Annex-B与 AVCC

两种不同的H264格式，详见[Annex-B与 AVCC](https://zhuanlan.zhihu.com/p/347039175)


## 工具联想

使用WebCodecs，可实现一个视频下载工具

## 开源项目参考

- [WebAV 是 Web 平台上创建/编辑视频文件的 SDK，基于 WebCodecs 构建](https://github.com/bilibili/WebAV)
  - 高性能：是 ffmpeg.wasm 的 20 倍， 体积小：约 50kb（MINIFIED + GZIPPED, 未 tree-shaking
  - 批量音视频文件处理；如：添加水印、配音、嵌入字幕
  - 构建音视频相关产品；如：视频剪辑、直播推流、视频动画制作
  - 兼容 chrome 102+
- [WASM 助力 WebCodecs：填补解封装能力的空白](https://juejin.cn/post/7443806845573955603)
- [web-demuxer](https://github.com/bilibili/web-demuxer)
  - 解封装
  - 兼容 chrome 102+
