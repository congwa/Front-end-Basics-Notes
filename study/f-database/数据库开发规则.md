# æ•°æ®åº“å¼€å‘è§„åˆ™

## ğŸ”’ æ ¸å¿ƒå®‰å…¨åŸåˆ™

### 1. æ•°æ®å®‰å…¨ç¬¬ä¸€
- âœ… æ‰€æœ‰æ•°æ®æ“ä½œå¿…é¡»ç¡®ä¿æ•°æ®å®‰å…¨
- âœ… ä½¿ç”¨è½¯åˆ é™¤æœºåˆ¶ï¼Œç¦æ­¢ç‰©ç†åˆ é™¤
- âœ… é‡è¦æ“ä½œå¿…é¡»è®°å½•å†å²å¿«ç…§
- âœ… æ‰€æœ‰å˜æ›´å¿…é¡»å¯å›æ»š

### 2. ç¦æ­¢ç ´åæ€§æ“ä½œ
- âŒ **ç¦æ­¢ä½¿ç”¨ DROP**ï¼ˆè¡¨ã€å­—æ®µã€å‡½æ•°ã€è§¦å‘å™¨ç­‰ï¼‰
- âŒ **ç¦æ­¢ä½¿ç”¨ DROP FUNCTION**ï¼ˆåŒ…æ‹¬ `DROP FUNCTION IF EXISTS`ï¼‰
- âŒ **ç¦æ­¢ç‰©ç†åˆ é™¤æ•°æ®**ï¼ˆä½¿ç”¨è½¯åˆ é™¤ä»£æ›¿ï¼‰
- âŒ **ç¦æ­¢å…¨è¡¨ UPDATE**ï¼ˆç‰¹åˆ«æ˜¯è®¾ç½®é»˜è®¤å€¼ï¼‰
- âŒ **ç¦æ­¢ä¿®æ”¹å·²æœ‰å­—æ®µç±»å‹**ï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼‰

**ä¸ºä»€ä¹ˆç¦æ­¢ DROP FUNCTIONï¼Ÿ**
- âŒ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒDROP FUNCTION ä¼šå¯¼è‡´æ­£åœ¨è°ƒç”¨è¯¥å‡½æ•°çš„è¯·æ±‚å¤±è´¥
- âŒ å³ä½¿ä½¿ç”¨ `IF EXISTS`ï¼Œåœ¨åˆ é™¤å’Œé‡å»ºä¹‹é—´ä»æœ‰æ—¶é—´çª—å£
- âŒ å¯èƒ½å¯¼è‡´å‡½æ•°æƒé™ä¸¢å¤±ï¼ˆGRANT æƒé™éœ€è¦é‡æ–°æˆäºˆï¼‰
- âŒ ä¸ç¬¦åˆé›¶åœæœºéƒ¨ç½²åŸåˆ™
- âœ… ä½¿ç”¨ `CREATE OR REPLACE FUNCTION` å¯ä»¥åŸå­æ€§åœ°æ›´æ–°å‡½æ•°

### 3. æ–°å¢å­—æ®µè§„èŒƒ
- âœ… **å¿…é¡»ä½¿ç”¨ `DEFAULT` è®¾ç½®é»˜è®¤å€¼**
- âŒ **ç¦æ­¢ä½¿ç”¨ UPDATE æ›´æ–°é»˜è®¤å€¼**
- âœ… æ–°å¢å­—æ®µå¿…é¡»å…è®¸ NULL æˆ–æœ‰åˆç†çš„é»˜è®¤å€¼
- âœ… ä½¿ç”¨ `ADD COLUMN IF NOT EXISTS` ç¡®ä¿å¹‚ç­‰æ€§

**âŒ é”™è¯¯ç¤ºä¾‹ï¼š**
```sql
-- âŒ ç¦æ­¢ï¼šå…ˆæ·»åŠ å­—æ®µï¼Œå†ç”¨ UPDATE è®¾ç½®é»˜è®¤å€¼
ALTER TABLE users ADD COLUMN status INTEGER;
UPDATE users SET status = 1 WHERE status IS NULL;  -- âŒ å…¨è¡¨æ›´æ–°ï¼

-- âŒ ç¦æ­¢ï¼šDROP å­—æ®µ
ALTER TABLE users DROP COLUMN old_field;  -- âŒ æ•°æ®æ°¸ä¹…ä¸¢å¤±ï¼

-- âŒ ç¦æ­¢ï¼šDROP FUNCTIONï¼ˆå³ä½¿æœ‰ IF EXISTSï¼‰
DROP FUNCTION IF EXISTS get_user_list;  -- âŒ ä¼šå¯¼è‡´æ­£åœ¨è°ƒç”¨çš„è¯·æ±‚å¤±è´¥ï¼
CREATE OR REPLACE FUNCTION get_user_list() ...;  -- ä¸åº”è¯¥å…ˆ DROP

-- âŒ ç¦æ­¢ï¼šç‰©ç†åˆ é™¤
DELETE FROM users WHERE id = 123;  -- âŒ åº”è¯¥ä½¿ç”¨è½¯åˆ é™¤ï¼
```

**âœ… æ­£ç¡®ç¤ºä¾‹ï¼š**
```sql
-- âœ… æ­£ç¡®ï¼šæ·»åŠ å­—æ®µæ—¶ç›´æ¥è®¾ç½® DEFAULT
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS status INTEGER NOT NULL DEFAULT 1;

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨ CREATE OR REPLACE FUNCTIONï¼ˆä¸è¦å…ˆ DROPï¼‰
CREATE OR REPLACE FUNCTION get_user_list()
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN jsonb_build_object('success', true);
END;
$$;

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨è½¯åˆ é™¤
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS delete_status INTEGER NOT NULL DEFAULT 0;

UPDATE users 
SET delete_status = 1, deleted_at = NOW() 
WHERE id = 123;  -- âœ… è½¯åˆ é™¤ï¼Œæ•°æ®å¯æ¢å¤

-- âœ… æ­£ç¡®ï¼šåºŸå¼ƒå­—æ®µè€Œä¸æ˜¯åˆ é™¤
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS old_field_deprecated BOOLEAN NOT NULL DEFAULT TRUE;

COMMENT ON COLUMN users.old_field IS 'å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ new_field';
```

## ğŸš« ç¦æ­¢ä½¿ç”¨çš„æ•°æ®åº“ç‰¹æ€§

### 1. å¤–é”®çº¦æŸï¼ˆFOREIGN KEYï¼‰

**ç¦æ­¢åŸå› ï¼š**
- âŒ å½±å“æ•°æ®åº“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹
- âŒ å¢åŠ æ•°æ®åº“ç»´æŠ¤å¤æ‚åº¦
- âŒ é™åˆ¶æ•°æ®è¿ç§»å’Œé‡æ„çš„çµæ´»æ€§
- âŒ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éš¾ä»¥ç®¡ç†
- âŒ åˆ é™¤æ“ä½œéœ€è¦çº§è”å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–çš„æ•°æ®åˆ é™¤

**ç¦æ­¢ç¤ºä¾‹ï¼š**
```sql
-- âŒ ç¦æ­¢ï¼šä½¿ç”¨å¤–é”®çº¦æŸ
CREATE TABLE orders (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id)
);

-- âŒ ç¦æ­¢ï¼šä½¿ç”¨ REFERENCES å…³é”®å­—
CREATE TABLE comments (
  post_id BIGINT REFERENCES posts(id)
);
```

**âœ… æ¨èåšæ³•ï¼š**
- åœ¨åº”ç”¨å±‚ç»´æŠ¤æ•°æ®å®Œæ•´æ€§
- é€šè¿‡ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- ä½¿ç”¨è½¯åˆ é™¤æœºåˆ¶ï¼Œé¿å…çº§è”åˆ é™¤é—®é¢˜

### 2. æ£€æŸ¥çº¦æŸï¼ˆCHECK CONSTRAINTï¼‰

**ç¦æ­¢åŸå› ï¼š**
- âŒ é™åˆ¶ä¸šåŠ¡æ‰©å±•çš„çµæ´»æ€§ï¼Œåç»­ä¿®æ”¹çº¦æŸéœ€è¦é‡æ„
- âŒ æ–°å¢æšä¸¾å€¼éœ€è¦ä¿®æ”¹è¡¨ç»“æ„ï¼ˆALTER TABLEï¼‰
- âŒ åœ¨ç”Ÿäº§ç¯å¢ƒä¿®æ”¹çº¦æŸå¯èƒ½å¯¼è‡´é”è¡¨
- âŒ çº¦æŸéªŒè¯å¤±è´¥ä¼šç›´æ¥å¯¼è‡´æ“ä½œå¤±è´¥ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
- âŒ ä¸šåŠ¡è§„åˆ™å˜åŒ–æ—¶ï¼Œéœ€è¦å…ˆç§»é™¤çº¦æŸå†æ·»åŠ æ–°çº¦æŸ

**ç¦æ­¢ç¤ºä¾‹ï¼š**
```sql
-- âŒ ç¦æ­¢ï¼šä½¿ç”¨ CHECK çº¦æŸé™åˆ¶çŠ¶æ€å€¼
CREATE TABLE orders (
  status INTEGER NOT NULL,
  CONSTRAINT chk_status CHECK (status IN (1, 2, 3))  -- âŒ åç»­æ‰©å±•éœ€è¦ä¿®æ”¹è¡¨
);

-- âŒ ç¦æ­¢ï¼šä½¿ç”¨ CHECK çº¦æŸé™åˆ¶èŒƒå›´
CREATE TABLE users (
  level INTEGER NOT NULL,
  CONSTRAINT chk_level CHECK (level >= 1 AND level <= 10)  -- âŒ ç­‰çº§æ‰©å±•éœ€è¦ä¿®æ”¹çº¦æŸ
);

-- âŒ ç¦æ­¢ï¼šä½¿ç”¨å†…è” CHECK çº¦æŸ
CREATE TABLE products (
  delete_status INTEGER NOT NULL DEFAULT 0 CHECK (delete_status IN (0, 1))  -- âŒ ç¦æ­¢
);
```

**âœ… æ¨èåšæ³•ï¼š**
- åœ¨åº”ç”¨å±‚è¿›è¡Œæ•°æ®éªŒè¯
- ä½¿ç”¨æ³¨é‡Šæ–‡æ¡£è®°å½•å­—æ®µçš„æœ‰æ•ˆå€¼èŒƒå›´
- é€šè¿‡ä»£ç å¸¸é‡æˆ–æšä¸¾ç®¡ç†ä¸šåŠ¡çŠ¶æ€å€¼

**ç¤ºä¾‹ï¼š**
```sql
-- âœ… æ­£ç¡®ï¼šä¸ä½¿ç”¨ CHECK çº¦æŸï¼Œåœ¨æ³¨é‡Šä¸­è¯´æ˜è§„åˆ™
CREATE TABLE orders (
  status INTEGER NOT NULL DEFAULT 1
);

COMMENT ON COLUMN orders.status IS 'è®¢å•çŠ¶æ€ï¼š1=å¾…æ”¯ä»˜ï¼Œ2=å·²æ”¯ä»˜ï¼Œ3=å·²å‘è´§ï¼Œ4=å·²å®Œæˆï¼Œ5=å·²å–æ¶ˆã€‚æ³¨æ„ï¼šåœ¨åº”ç”¨å±‚è¿›è¡Œå€¼æ ¡éªŒ';
```

**ç¤ºä¾‹ï¼šä¸ä½¿ç”¨å¤–é”®ï¼Œä½¿ç”¨ç´¢å¼•å’Œåº”ç”¨å±‚æ£€æŸ¥**
```sql
-- âœ… æ­£ç¡®ï¼šä»…ä½¿ç”¨ç´¢å¼•ï¼Œä¸å®šä¹‰å¤–é”®
CREATE TABLE order_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  order_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  quantity INTEGER NOT NULL DEFAULT 1,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_product_id ON order_items(product_id);
```

## âœ… æ¨èä½¿ç”¨çš„æ•°æ®åº“ç‰¹æ€§

### 1. ç´¢å¼•ï¼ˆINDEXï¼‰
```sql
-- âœ… æ¨èï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_products_category_id ON products(category_id);
```

### 2. å”¯ä¸€çº¦æŸï¼ˆUNIQUE CONSTRAINTï¼‰
```sql
-- âœ… æ¨èï¼šä½¿ç”¨å”¯ä¸€çº¦æŸä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼ˆä»…å¯¹æ–°è¡¨ï¼‰
CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  email VARCHAR(255) NOT NULL,
  CONSTRAINT uk_users_email UNIQUE (email)
);

-- âš ï¸ æ³¨æ„ï¼šå·²æœ‰è¡¨æ·»åŠ å”¯ä¸€çº¦æŸéœ€è°¨æ…ï¼Œç¡®ä¿æ•°æ®æ— é‡å¤
-- å»ºè®®å…ˆæŸ¥è¯¢æ£€æŸ¥ï¼Œå†å†³å®šæ˜¯å¦æ·»åŠ 
```

### 3. æ³¨é‡Šè¯´æ˜ï¼ˆå¼ºçƒˆæ¨èï¼‰
```sql
-- âœ… æ¨èï¼šä¸ºå­—æ®µæ·»åŠ è¯¦ç»†æ³¨é‡Šè¯´æ˜
COMMENT ON TABLE users IS 'ç”¨æˆ·è¡¨ï¼ˆæ”¯æŒè½¯åˆ é™¤ï¼‰';
COMMENT ON COLUMN users.status IS 'ç”¨æˆ·çŠ¶æ€ï¼š1=æ­£å¸¸ï¼Œ2=ç¦ç”¨ï¼Œ3=å·²æ³¨é”€ã€‚åœ¨åº”ç”¨å±‚è¿›è¡Œå€¼æ ¡éªŒ';
COMMENT ON COLUMN users.level IS 'ç”¨æˆ·ç­‰çº§ï¼š1-10ã€‚åœ¨åº”ç”¨å±‚éªŒè¯èŒƒå›´';

-- âœ… ä½¿ç”¨æ³¨é‡Šä»£æ›¿ CHECK çº¦æŸï¼Œä¿æŒçµæ´»æ€§
COMMENT ON COLUMN orders.priority IS 'ä¼˜å…ˆçº§ï¼š1=ä½ï¼Œ2=ä¸­ï¼Œ3=é«˜ã€‚åœ¨åº”ç”¨å±‚éªŒè¯';
```

### 4. è½¯åˆ é™¤æœºåˆ¶ï¼ˆå¿…é¡»ä½¿ç”¨ï¼‰
```sql
-- âœ… æ‰€æœ‰è¡¨å¿…é¡»åŒ…å«è½¯åˆ é™¤å­—æ®µ
CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  
  -- è½¯åˆ é™¤å­—æ®µï¼ˆå¿…éœ€ï¼‰
  delete_status INTEGER NOT NULL DEFAULT 0,
  deleted_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- æ·»åŠ æ³¨é‡Šè¯´æ˜å­—æ®µè§„åˆ™
COMMENT ON COLUMN users.delete_status IS 'åˆ é™¤çŠ¶æ€ï¼š0=æ­£å¸¸ï¼Œ1=å·²åˆ é™¤ã€‚åœ¨åº”ç”¨å±‚éªŒè¯';

-- åˆ›å»ºç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_users_delete_status ON users(delete_status);

-- æŸ¥è¯¢æ—¶é»˜è®¤è¿‡æ»¤å·²åˆ é™¤æ•°æ®
SELECT * FROM users WHERE delete_status = 0;

-- è½¯åˆ é™¤æ“ä½œ
UPDATE users 
SET delete_status = 1, 
    deleted_at = NOW(),
    operator_id = 'current_user'
WHERE id = 123 AND delete_status = 0;

-- æ¢å¤æ•°æ®
UPDATE users 
SET delete_status = 0, 
    deleted_at = NULL,
    operator_id = 'current_user'
WHERE id = 123 AND delete_status = 1;
```

**UPDATE æ“ä½œå®‰å…¨è§„èŒƒï¼ˆé‡è¦ï¼ï¼‰ï¼š**
1. âœ… **å¿…é¡»ä½¿ç”¨ WHERE å­å¥è¿›è¡Œçº¦æŸ**
2. âœ… **å¿…é¡»æ ¡éªŒ WHERE æ¡ä»¶ï¼Œé˜²æ­¢å…¨è¡¨æ›´æ–°**
3. âœ… **å¿…é¡»æ£€æŸ¥å—å½±å“çš„è¡Œæ•°ï¼ˆROW_COUNTï¼‰**
4. âœ… **WHERE æ¡ä»¶å¿…é¡»åŒ…å«æ˜ç¡®çš„ä¸»é”®æˆ–å”¯ä¸€æ ‡è¯†**
5. 
**UPDATE æ“ä½œæ£€æŸ¥æ¸…å•ï¼š**
- [ ] WHERE å­å¥å­˜åœ¨ä¸”ä¸ä¸ºç©º
- [ ] WHERE æ¡ä»¶åŒ…å«ä¸»é”®æˆ–å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ `id = p_id`ï¼‰
- [ ] WHERE æ¡ä»¶ä¸ä¼šå› ä¸ºå‚æ•°ä¸º NULL è€ŒåŒ¹é…å…¨è¡¨
- [ ] ä½¿ç”¨ `GET DIAGNOSTICS v_affected_rows = ROW_COUNT` æ£€æŸ¥å½±å“è¡Œæ•°
- [ ] æ‰¹é‡æ›´æ–°æœ‰æ•°é‡é™åˆ¶ï¼ˆå»ºè®®ä¸è¶…è¿‡ 100 æ¡ï¼‰
- [ ] æ›´æ–°æ“ä½œè®°å½•äº†æ“ä½œå‘˜ä¿¡æ¯ï¼ˆ`operator_id`ï¼‰
- [ ] æ›´æ–°æ“ä½œæ›´æ–°äº† `updated_at` æ—¶é—´æˆ³

### å¾ªç¯ä¸­çš„ SQL æ“ä½œï¼ˆä¸¥æ ¼ç¦æ­¢ï¼ï¼‰

**ç¦æ­¢è§„åˆ™ï¼š**
1. âŒ **ç¦æ­¢åœ¨ä»»ä½•å¾ªç¯ä¸­æ‰§è¡Œ SQL æ“ä½œ**ï¼ˆLOOPã€FORã€WHILEã€FOREACHï¼‰
2. âŒ **ç¦æ­¢ä½¿ç”¨é€’å½’æŸ¥è¯¢ä¸­æ‰§è¡Œ DML æ“ä½œ**ï¼ˆINSERTã€UPDATEã€DELETEï¼‰
3. âŒ **ç¦æ­¢åœ¨æ•°ç»„éå†ä¸­æ‰§è¡Œ SQL æ“ä½œ**
4. âœ… **å¿…é¡»ä½¿ç”¨æ‰¹é‡æ“ä½œ**ï¼ˆæ•°ç»„ã€UNNESTã€æ‰¹é‡ INSERT/UPDATEï¼‰

**æ€§èƒ½å½±å“ï¼š**
- å¾ªç¯ 100 æ¬¡ = 100 æ¬¡æ•°æ®åº“å¾€è¿” = ä¸¥é‡æ€§èƒ½é—®é¢˜
- æ‰¹é‡æ“ä½œ 1 æ¬¡ = 1 æ¬¡æ•°æ®åº“å¾€è¿” = é«˜æ€§èƒ½

**âŒ é”™è¯¯ç¤ºä¾‹ï¼š**
```sql
-- âŒ ç¦æ­¢ï¼šåœ¨ FOR å¾ªç¯ä¸­æ‰§è¡Œ INSERT
CREATE OR REPLACE FUNCTION bad_batch_insert(p_user_ids BIGINT[])
RETURNS JSONB AS $$
DECLARE
  v_user_id BIGINT;
BEGIN
  -- âŒ æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡Œä¸€æ¬¡ INSERTï¼Œæ€§èƒ½æå·®
  FOREACH v_user_id IN ARRAY p_user_ids LOOP
    INSERT INTO user_logs (user_id, action)
    VALUES (v_user_id, 'login');
  END LOOP;
  
  RETURN jsonb_build_object('success', true);
END;
$$ LANGUAGE plpgsql;

-- âŒ ç¦æ­¢ï¼šåœ¨ FOR å¾ªç¯ä¸­æ‰§è¡Œ UPDATE
CREATE OR REPLACE FUNCTION bad_batch_update()
RETURNS JSONB AS $$
DECLARE
  v_record RECORD;
BEGIN
  -- âŒ æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡Œä¸€æ¬¡ UPDATE
  FOR v_record IN SELECT id FROM users LOOP
    UPDATE users 
    SET updated_at = NOW() 
    WHERE id = v_record.id;
  END LOOP;
  
  RETURN jsonb_build_object('success', true);
END;
$$ LANGUAGE plpgsql;

-- âŒ ç¦æ­¢ï¼šåœ¨ WHILE å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢å’Œæ›´æ–°
CREATE OR REPLACE FUNCTION bad_recursive_update()
RETURNS JSONB AS $$
DECLARE
  v_count INTEGER := 0;
  v_user_id BIGINT;
BEGIN
  WHILE v_count < 100 LOOP
    -- âŒ å¾ªç¯ä¸­æ‰§è¡Œ SELECT
    SELECT id INTO v_user_id 
    FROM users 
    WHERE status = 1 
    LIMIT 1;
    
    -- âŒ å¾ªç¯ä¸­æ‰§è¡Œ UPDATE
    UPDATE users 
    SET status = 2 
    WHERE id = v_user_id;
    
    v_count := v_count + 1;
  END LOOP;
  
  RETURN jsonb_build_object('success', true);
END;
$$ LANGUAGE plpgsql;

-- âŒ ç¦æ­¢ï¼šåœ¨é€’å½’ CTE ä¸­æ‰§è¡Œ UPDATEï¼ˆè™½ç„¶è¯­æ³•ä¸å…è®¸ï¼Œä½†æ¦‚å¿µä¸Šç¦æ­¢ï¼‰
-- é€’å½’åº”è¯¥åªç”¨äºæŸ¥è¯¢ï¼Œä¸ç”¨äºæ•°æ®ä¿®æ”¹
```

**âœ… æ­£ç¡®ç¤ºä¾‹ï¼š**
```sql
-- âœ… æ–¹å¼1ï¼šä½¿ç”¨ UNNEST è¿›è¡Œæ‰¹é‡ INSERT
CREATE OR REPLACE FUNCTION batch_insert_logs(
  p_user_ids BIGINT[],
  p_action TEXT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_inserted_count INTEGER;
BEGIN
  -- å‚æ•°æ ¡éªŒ
  IF p_user_ids IS NULL OR array_length(p_user_ids, 1) = 0 THEN
    RETURN jsonb_build_object('success', false, 'error', 'ç”¨æˆ·IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º');
  END IF;
  
  -- âœ… ä¸€æ¬¡æ€§æ‰¹é‡æ’å…¥ï¼Œæ— å¾ªç¯
  INSERT INTO user_logs (user_id, action)
  SELECT unnest, p_action 
  FROM unnest(p_user_ids)
  ON CONFLICT (user_id, action) DO NOTHING;
  
  GET DIAGNOSTICS v_inserted_count = ROW_COUNT;
  
  RETURN jsonb_build_object(
    'success', true, 
    'inserted_count', v_inserted_count
  );
END;
$$;

-- âœ… æ–¹å¼2ï¼šä½¿ç”¨ WHERE IN æ‰¹é‡ UPDATE
CREATE OR REPLACE FUNCTION batch_update_user_status(
  p_user_ids BIGINT[],
  p_status INTEGER
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_updated_count INTEGER;
BEGIN
  -- å‚æ•°æ ¡éªŒ
  IF p_user_ids IS NULL OR array_length(p_user_ids, 1) = 0 THEN
    RETURN jsonb_build_object('success', false, 'error', 'ç”¨æˆ·IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º');
  END IF;
  
  -- âœ… ä¸€æ¬¡æ€§æ‰¹é‡æ›´æ–°ï¼Œæ— å¾ªç¯
  UPDATE users 
  SET status = p_status,
      updated_at = NOW()
  WHERE id = ANY(p_user_ids)
    AND delete_status = 0;
  
  GET DIAGNOSTICS v_updated_count = ROW_COUNT;
  
  RETURN jsonb_build_object(
    'success', true,
    'updated_count', v_updated_count
  );
END;
$$;

-- âœ… æ–¹å¼3ï¼šä½¿ç”¨ UPDATE FROM è”è¡¨æ‰¹é‡æ›´æ–°
CREATE OR REPLACE FUNCTION batch_update_from_json(
  p_updates JSONB  -- [{"id": 1, "name": "æ–°åç§°"}, ...]
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_updated_count INTEGER;
BEGIN
  -- âœ… ä½¿ç”¨ UPDATE FROM å­æŸ¥è¯¢ï¼Œä¸€æ¬¡æ€§æ‰¹é‡æ›´æ–°
  UPDATE users t
  SET name = u.name,
      updated_at = NOW()
  FROM (
    SELECT 
      (value->>'id')::BIGINT AS id,
      value->>'name' AS name
    FROM jsonb_array_elements(p_updates)
  ) u
  WHERE t.id = u.id
    AND t.delete_status = 0;
  
  GET DIAGNOSTICS v_updated_count = ROW_COUNT;
  
  RETURN jsonb_build_object(
    'success', true,
    'updated_count', v_updated_count
  );
END;
$$;

-- âœ… æ–¹å¼4ï¼šä½¿ç”¨ CTE è¿›è¡Œå¤æ‚æ‰¹é‡æ“ä½œ
CREATE OR REPLACE FUNCTION batch_move_users(
  p_user_ids BIGINT[],
  p_new_department_id BIGINT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_result JSONB;
BEGIN
  -- âœ… ä½¿ç”¨ CTE ä¸€æ¬¡æ€§å®ŒæˆéªŒè¯å’Œæ›´æ–°
  WITH validated_users AS (
    SELECT id 
    FROM users
    WHERE id = ANY(p_user_ids)
      AND delete_status = 0
  ),
  updated AS (
    UPDATE users t
    SET department_id = p_new_department_id,
        updated_at = NOW()
    FROM validated_users v
    WHERE t.id = v.id
    RETURNING t.id
  )
  SELECT jsonb_build_object(
    'success', true,
    'updated_count', COUNT(*),
    'updated_ids', jsonb_agg(id)
  ) INTO v_result
  FROM updated;
  
  RETURN COALESCE(v_result, jsonb_build_object('success', true, 'updated_count', 0));
END;
$$;

-- âœ… æ–¹å¼5ï¼šé€’å½’æŸ¥è¯¢ä»…ç”¨äºæ•°æ®æ£€ç´¢ï¼Œä¸ç”¨äºä¿®æ”¹
CREATE OR REPLACE FUNCTION get_category_tree(p_parent_id BIGINT)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- âœ… é€’å½’ CTE ä»…ç”¨äºæŸ¥è¯¢ï¼Œä¸æ‰§è¡Œ DML
  RETURN (
    WITH RECURSIVE category_tree AS (
      -- æ ¹èŠ‚ç‚¹
      SELECT id, name, parent_id, 0 AS level
      FROM categories
      WHERE parent_id = p_parent_id
        AND delete_status = 0
      
      UNION ALL
      
      -- é€’å½’æŸ¥è¯¢å­èŠ‚ç‚¹
      SELECT c.id, c.name, c.parent_id, ct.level + 1
      FROM categories c
      INNER JOIN category_tree ct ON c.parent_id = ct.id
      WHERE c.delete_status = 0
        AND ct.level < 10  -- é™åˆ¶é€’å½’æ·±åº¦
    )
    SELECT jsonb_build_object(
      'success', true,
      'data', COALESCE(jsonb_agg(row_to_json(category_tree)), '[]'::jsonb)
    )
    FROM category_tree
  );
END;
$$;
```

**å¾ªç¯æ“ä½œæ£€æŸ¥æ¸…å•ï¼š**
- [ ] æ²¡æœ‰åœ¨ LOOPã€FORã€WHILEã€FOREACH ä¸­æ‰§è¡Œ SQL
- [ ] æ²¡æœ‰åœ¨é€’å½’å‡½æ•°ä¸­æ‰§è¡Œ DML æ“ä½œ
- [ ] æ‰¹é‡æ“ä½œä½¿ç”¨äº†æ•°ç»„å‚æ•°ï¼ˆ`BIGINT[]`ã€`TEXT[]`ï¼‰
- [ ] ä½¿ç”¨äº† `UNNEST`ã€`ANY`ã€`UPDATE FROM` ç­‰æ‰¹é‡æ“ä½œè¯­æ³•
- [ ] æ‰¹é‡æ“ä½œæœ‰æ•°é‡é™åˆ¶å’ŒéªŒè¯
- [ ] é€’å½’æŸ¥è¯¢ä»…ç”¨äºæ•°æ®æ£€ç´¢ï¼Œä¸ç”¨äºä¿®æ”¹
- [ ] é€’å½’æŸ¥è¯¢è®¾ç½®äº†æ·±åº¦é™åˆ¶ï¼ˆé˜²æ­¢æ— é™é€’å½’ï¼‰

## ğŸ“ è¡¨å­—æ®µå˜æ›´è§„èŒƒ

### æ–°å¢å­—æ®µï¼ˆæ¨èåšæ³•ï¼‰

**âœ… æ­£ç¡®ç¤ºä¾‹ï¼š**
```sql
-- âœ… æ–¹å¼1ï¼šæ·»åŠ å¯ä¸ºç©ºçš„å­—æ®µ
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS nickname VARCHAR(100);

-- âœ… æ–¹å¼2ï¼šæ·»åŠ å¸¦é»˜è®¤å€¼çš„å­—æ®µï¼ˆæ¨èï¼‰
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS status INTEGER NOT NULL DEFAULT 1;

-- âœ… æ–¹å¼3ï¼šæ·»åŠ æ•´æ•°å­—æ®µï¼ˆåœ¨åº”ç”¨å±‚éªŒè¯èŒƒå›´ï¼‰
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS level INTEGER NOT NULL DEFAULT 1;

-- âœ… æ·»åŠ æ³¨é‡Šè¯´æ˜
COMMENT ON COLUMN users.nickname IS 'ç”¨æˆ·æ˜µç§°ï¼Œå¯é€‰å­—æ®µ';
```

**âŒ é”™è¯¯ç¤ºä¾‹ï¼š**
```sql
-- âŒ ç¦æ­¢ï¼šå…ˆæ·»åŠ å­—æ®µï¼Œå†å…¨è¡¨ UPDATE
ALTER TABLE users ADD COLUMN status INTEGER;
UPDATE users SET status = 1;  -- âŒ å…¨è¡¨æ›´æ–°ï¼æ€§èƒ½å·®ä¸”é£é™©é«˜

-- âŒ ç¦æ­¢ï¼šæ·»åŠ  NOT NULL å­—æ®µä½†æ²¡æœ‰é»˜è®¤å€¼ï¼ˆä¼šæŠ¥é”™ï¼‰
ALTER TABLE users 
ADD COLUMN status INTEGER NOT NULL;  -- âŒ å·²æœ‰æ•°æ®æ— æ³•æ»¡è¶³ NOT NULL

-- âŒ ç¦æ­¢ï¼šä½¿ç”¨ UPDATE æ›¿ä»£ DEFAULT
ALTER TABLE users ADD COLUMN created_at TIMESTAMPTZ;
UPDATE users SET created_at = NOW();  -- âŒ åº”è¯¥ä½¿ç”¨ DEFAULT NOW()
```

### ä¿®æ”¹å­—æ®µï¼ˆè°¨æ…æ“ä½œï¼‰

**âš ï¸ é«˜é£é™©æ“ä½œï¼Œéœ€è¦ç‰¹åˆ«è¯„ä¼°ï¼š**
```sql
-- âš ï¸ æ‰©å¤§å­—æ®µé•¿åº¦ï¼ˆç›¸å¯¹å®‰å…¨ï¼‰
ALTER TABLE users 
ALTER COLUMN name TYPE VARCHAR(200);

-- âŒ ç¦æ­¢ï¼šç¼©å°å­—æ®µé•¿åº¦ï¼ˆå¯èƒ½æˆªæ–­æ•°æ®ï¼‰
ALTER TABLE users 
ALTER COLUMN name TYPE VARCHAR(50);  -- âŒ å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±

-- âŒ ç¦æ­¢ï¼šä¿®æ”¹å­—æ®µç±»å‹ï¼ˆå¯èƒ½æ•°æ®ä¸å…¼å®¹ï¼‰
ALTER TABLE orders 
ALTER COLUMN price TYPE INTEGER;  -- âŒ DECIMAL â†’ INTEGER ä¼šä¸¢å¤±å°æ•°

-- âœ… æ¨èï¼šæ–°å¢å­—æ®µä»£æ›¿ä¿®æ”¹
ALTER TABLE orders 
ADD COLUMN IF NOT EXISTS price_new DECIMAL(10, 2);
-- åº”ç”¨å±‚é€æ­¥è¿ç§»æ•°æ®ï¼Œæ—§å­—æ®µæ ‡è®°ä¸ºåºŸå¼ƒ
```

### åˆ é™¤å­—æ®µï¼ˆç¦æ­¢ï¼‰

**âŒ æ°¸è¿œä¸è¦ç‰©ç†åˆ é™¤å­—æ®µï¼š**
```sql
-- âŒ ç¦æ­¢ï¼šDROP COLUMN
ALTER TABLE users DROP COLUMN old_field;  -- âŒ æ•°æ®æ°¸ä¹…ä¸¢å¤±ï¼

-- âœ… æ¨èï¼šæ ‡è®°å­—æ®µä¸ºåºŸå¼ƒ
COMMENT ON COLUMN users.old_field IS 
  '[DEPRECATED] å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ new_fieldï¼Œè®¡åˆ’åœ¨ 2025-12 åç§»é™¤';

-- æˆ–è€…æ·»åŠ åºŸå¼ƒæ ‡è®°å­—æ®µ
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS _deprecated_fields TEXT[] DEFAULT '{"old_field"}';
```

## ğŸ—‘ï¸ è½¯åˆ é™¤å®æ–½è§„èŒƒ

### è¡¨ç»“æ„è¦æ±‚

æ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
```sql
CREATE TABLE users (
  -- ä¸šåŠ¡å­—æ®µ
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  
  -- è½¯åˆ é™¤å­—æ®µï¼ˆå¿…éœ€ï¼‰
  delete_status INTEGER NOT NULL DEFAULT 0,
  deleted_at TIMESTAMPTZ,
  deleted_by VARCHAR(255),  -- åˆ é™¤æ“ä½œå‘˜
  
  -- å®¡è®¡å­—æ®µï¼ˆæ¨èï¼‰
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  operator_id VARCHAR(255)
);

-- æ·»åŠ æ³¨é‡Šè¯´æ˜
COMMENT ON COLUMN users.delete_status IS 'åˆ é™¤çŠ¶æ€ï¼š0=æ­£å¸¸ï¼Œ1=å·²åˆ é™¤ã€‚åœ¨åº”ç”¨å±‚è¿›è¡Œå€¼æ ¡éªŒ';

-- å¿…éœ€çš„ç´¢å¼•
CREATE INDEX idx_users_delete_status ON users(delete_status);
CREATE INDEX idx_users_deleted_at ON users(deleted_at) WHERE delete_status = 1;
```

## ğŸ“‹ ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

åœ¨æäº¤æ•°æ®åº“è„šæœ¬å‰ï¼Œè¯·ç¡®è®¤ï¼š

### å®‰å…¨æ€§æ£€æŸ¥
- [ ] **æ²¡æœ‰ä½¿ç”¨ DROP** è¯­å¥ï¼ˆè¡¨ã€å­—æ®µã€å‡½æ•°ã€è§¦å‘å™¨ç­‰ï¼‰
- [ ] **æ²¡æœ‰ç‰©ç†åˆ é™¤æ•°æ®**ï¼ˆDELETE è¯­å¥ä»…ç”¨äºæµ‹è¯•æ•°æ®ï¼‰
- [ ] **æ²¡æœ‰å…¨è¡¨ UPDATE** è®¾ç½®é»˜è®¤å€¼
- [ ] **æ–°å¢å­—æ®µä½¿ç”¨äº† DEFAULT** è€Œä¸æ˜¯ UPDATE
- [ ] **ä½¿ç”¨äº†è½¯åˆ é™¤æœºåˆ¶**ï¼ˆdelete_status å­—æ®µï¼‰
- [ ] **æ²¡æœ‰åœ¨å¾ªç¯ä¸­æ‰§è¡Œ SQL**ï¼ˆLOOPã€FORã€WHILEã€FOREACHï¼‰
- [ ] **æ²¡æœ‰åœ¨é€’å½’ä¸­æ‰§è¡Œ DML**ï¼ˆINSERTã€UPDATEã€DELETEï¼‰

### æ€§èƒ½å’Œå®Œæ•´æ€§æ£€æŸ¥
- [ ] æ²¡æœ‰ä½¿ç”¨ `FOREIGN KEY` æˆ– `REFERENCES` å…³é”®å­—
- [ ] æ²¡æœ‰ä½¿ç”¨ `CHECK` çº¦æŸï¼ˆä½¿ç”¨åº”ç”¨å±‚éªŒè¯ä»£æ›¿ï¼‰
- [ ] ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºäº†é€‚å½“çš„ç´¢å¼•
- [ ] ä½¿ç”¨äº†é€‚å½“çš„å”¯ä¸€çº¦æŸï¼ˆä»…æ–°è¡¨ï¼‰
- [ ] æ–°å¢å­—æ®µæœ‰åˆç†çš„é»˜è®¤å€¼æˆ–å…è®¸ NULL
- [ ] ä¸ºå­—æ®µæ·»åŠ äº†è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜ï¼ˆç‰¹åˆ«æ˜¯çŠ¶æ€ã€æšä¸¾ç±»å­—æ®µï¼‰

### æ•°æ®å®‰å…¨æ£€æŸ¥
- [ ] é‡è¦æ“ä½œæœ‰å†å²è®°å½•/å¿«ç…§æœºåˆ¶
- [ ] è½¯åˆ é™¤æ“ä½œè®°å½•äº†æ“ä½œå‘˜ä¿¡æ¯
- [ ] æŸ¥è¯¢å‡½æ•°é»˜è®¤è¿‡æ»¤
- [ ] æä¾›äº†æ•°æ®æ¢å¤å‡½æ•°

## âš ï¸ é«˜é£é™©æ“ä½œæ¸…å•

ä»¥ä¸‹æ“ä½œéœ€è¦**ç‰¹åˆ«è¯„ä¼°å’Œå®¡æ‰¹**ï¼š

### ğŸ”´ ä¸¥é‡é£é™©ï¼ˆç¦æ­¢ï¼‰
- âŒ `DROP TABLE` - æ°¸ä¹…åˆ é™¤è¡¨
- âŒ `DROP COLUMN` - æ°¸ä¹…åˆ é™¤å­—æ®µ
- âŒ `DELETE FROM table` - ç‰©ç†åˆ é™¤æ•°æ®
- âŒ `TRUNCATE TABLE` - æ¸…ç©ºè¡¨æ•°æ®
- âŒ **`UPDATE table SET ...` æ²¡æœ‰ WHERE å­å¥** - å…¨è¡¨æ›´æ–°
- âŒ **åœ¨å¾ªç¯ä¸­æ‰§è¡Œ SQL æ“ä½œ** - ä¸¥é‡æ€§èƒ½é—®é¢˜ï¼ˆN+1 é—®é¢˜ï¼‰
- âŒ **åœ¨é€’å½’å‡½æ•°ä¸­æ‰§è¡Œ DML æ“ä½œ** - æ€§èƒ½å·®ä¸”éš¾ä»¥æ§åˆ¶
- âŒ ä¿®æ”¹ä¸»é”®å­—æ®µç±»å‹
- âŒ åˆ é™¤å”¯ä¸€çº¦æŸï¼ˆå¯èƒ½å¯¼è‡´æ•°æ®é‡å¤ï¼‰

### ğŸŸ¡ ä¸­ç­‰é£é™©ï¼ˆéœ€å®¡æ‰¹ï¼‰
- âš ï¸ `ALTER COLUMN TYPE` - ä¿®æ”¹å­—æ®µç±»å‹
- âš ï¸ `UPDATE` å…¨è¡¨ - å…¨è¡¨æ›´æ–°æ•°æ®
- âš ï¸ æ·»åŠ  `NOT NULL` çº¦æŸåˆ°å·²æœ‰å­—æ®µ
- âš ï¸ æ·»åŠ å”¯ä¸€çº¦æŸåˆ°å·²æœ‰å­—æ®µ
- âš ï¸ æ·»åŠ æˆ–åˆ é™¤ `CHECK` çº¦æŸï¼ˆä¸æ¨èä½¿ç”¨ï¼‰
- âš ï¸ é‡å‘½åå­—æ®µæˆ–è¡¨

### ğŸŸ¢ ä½é£é™©ï¼ˆæ¨èï¼‰
- âœ… `ADD COLUMN IF NOT EXISTS` - æ·»åŠ æ–°å­—æ®µ
- âœ… `CREATE INDEX IF NOT EXISTS` - åˆ›å»ºç´¢å¼•
- âœ… `CREATE OR REPLACE FUNCTION` - æ›´æ–°å‡½æ•°
- âœ… `COMMENT ON` - æ·»åŠ æ³¨é‡Š
- âœ… æ‰©å¤§å­—æ®µé•¿åº¦ï¼ˆVARCHAR å¢å¤§ï¼‰

## ğŸ” è¿ç§»ç°æœ‰ä»£ç 

å¦‚æœå‘ç°ç°æœ‰ä»£ç ä½¿ç”¨äº†å¤–é”®çº¦æŸæˆ–ç‰©ç†åˆ é™¤ï¼Œéœ€è¦è¿›è¡Œè¿ç§»ï¼š

### è¿ç§»å¤–é”®çº¦æŸ
1. âŒ åˆ é™¤å¤–é”®çº¦æŸå®šä¹‰ï¼ˆä½¿ç”¨ `ALTER TABLE ... DROP CONSTRAINT`ï¼Œä»…æ­¤ä¸€æ¬¡ï¼‰
2. âœ… ä¿ç•™æˆ–åˆ›å»ºç›¸åº”çš„ç´¢å¼•

### è¿ç§»ç‰©ç†åˆ é™¤ä¸ºè½¯åˆ é™¤
1. âœ… æ·»åŠ è½¯åˆ é™¤å­—æ®µï¼ˆä½¿ç”¨ DEFAULTï¼‰
2. âœ… åˆ›å»ºè½¯åˆ é™¤ç›¸å…³ç´¢å¼•
3. âœ… ä¿®æ”¹æ‰€æœ‰ DELETE æ“ä½œä¸º UPDATE
4. âœ… ä¿®æ”¹æ‰€æœ‰æŸ¥è¯¢æ·»åŠ  `WHERE delete_status = 0`

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ç´¢å¼•ç­–ç•¥
```sql
-- âœ… ä¸ºè½¯åˆ é™¤å­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_delete_status ON users(delete_status);

-- âœ… ä¸ºå¸¸ç”¨æŸ¥è¯¢æ¡ä»¶åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_users_status_created ON users(status, created_at DESC)
WHERE delete_status = 0;

-- âœ… ä¸ºå·²åˆ é™¤æ•°æ®åˆ›å»ºéƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_users_deleted ON users(deleted_at)
WHERE delete_status = 1;
```

### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- âœ… é»˜è®¤è¿‡æ»¤å·²åˆ é™¤æ•°æ®
SELECT * FROM users 
WHERE delete_status = 0  -- åˆ©ç”¨ç´¢å¼•
  AND status = 1
ORDER BY created_at DESC;

-- âš ï¸ é¿å… OR æ¡ä»¶ï¼ˆå¯èƒ½ä¸èµ°ç´¢å¼•ï¼‰
-- ä½¿ç”¨ UNION ä»£æ›¿
SELECT * FROM users WHERE delete_status = 0 AND status = 1
UNION ALL
SELECT * FROM users WHERE delete_status = 0 AND status = 2;
```

