# 代码库索引揭秘

## 1. 缘起： [roocode加入了代码库索引功能](https://docs.roocode.com/features/experimental/codebase-indexing)

索引流程

1. 使用 Tree-sitter 解析代码以识别语义块（函数、类、方法）
2. 使用 AI 模型为每个代码块生成嵌入
3. 存储向量至 Qdrant 数据库以实现快速相似搜索
4. 提供了 codebase_search 工具给 Roo，用于智能代码搜索

这使得可以使用诸如“用户身份验证逻辑”或“数据库连接处理”之类的自然语言查询，在整个项目中找到相关的代码

优点

1. 语义搜索：根据意义而非关键词查找代码
2. 提升 AI 理解能力：Roo 能够更好地理解和处理你的代码库
3. 跨项目发现：在所有文件中进行搜索，而不仅仅是当前打开的文件
4. 模式识别：查找相似的实现和代码模式


文件是如何被处理的

智能代码解析

1. 树坐标的集成：使用 AST 解析来识别语义代码块
2. 语言支持：Tree-sitter 支持的所有编程语言
3. 默认：不支持的文件类型按行分块处理
4. 块尺寸限制：
   - 最小长度：100字符
   - 最大长度：1,000字符
   - 对超长函数进行智能分块处理

自动文件筛选

自动忽略：
- 二进制文件和图片
- 大文件 (>1MB)  大文件不配索引
- Git 仓库（.git 文件夹）
- 依赖项（node_modules、vendor 等）
- 匹配 .gitignore 和 .rooignore 模式的文件

增量更新：

- 文件监视：监控工作区的更改
- 智能更新：仅重新处理已修改的文件
- 基于哈希的缓存：避免重新处理未修改的内容
- 自动管理：Git 分支切换时自动处理

## cursor是如何处理的呢

核心思路：
- 1️⃣ 本地用 AST 分割代码 → 构建 Merkle 树"指纹"
- 2️⃣ 只同步变更文件（增量更新，节省 90%+ 带宽）
- 3️⃣ 代码块 → Embedding 向量 → Turbopuffer 向量数据库
- 4️⃣ 用户提问 → 语义搜索 → 本地读取源码 → LLM 生成答案
![cursor处理代码库索引的核心思路](/study/imgs/cursor-rag.jpeg)

