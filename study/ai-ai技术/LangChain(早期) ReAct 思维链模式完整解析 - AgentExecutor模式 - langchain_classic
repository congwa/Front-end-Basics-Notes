

# LangChain(æ—©æœŸ) ReAct æ€ç»´é“¾æ¨¡å¼å®Œæ•´è§£æ - AgentExecutoræ¨¡å¼

## ğŸ“‹ ç¬¬ä¸€éƒ¨åˆ†ï¼šReAct æ¨¡å¼çš„å®ç°åŸç†

### ä¸€ã€ä»€ä¹ˆæ˜¯ ReActï¼Ÿ

ReAct (Reasoning + Acting) æ˜¯ä¸€ç§è®© LLM äº¤æ›¿è¿›è¡Œ **æ¨ç†æ€è€ƒ** å’Œ **æ‰§è¡ŒåŠ¨ä½œ** çš„æ¨¡å¼ï¼Œæ¥æºäºè®ºæ–‡ [ReAct: Synergizing Reasoning and Acting in Language Models](https://arxiv.org/abs/2210.03629)ã€‚

### äºŒã€æ ¸å¿ƒæ¶æ„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ReAct Agent æ‰§è¡Œæµç¨‹                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ç”¨æˆ·è¾“å…¥    â”‚â”€â”€â”€â–¶â”‚                   AgentExecutor                           â”‚ â”‚
â”‚  â”‚  (Question)  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚                ä¸»å¾ªç¯ (_call)                        â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚  while should_continue:                             â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚ Step 1: æ„å»º Prompt                        â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   - tools æè¿°                             â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   - tool_names                             â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   - input (ç”¨æˆ·é—®é¢˜)                        â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   - agent_scratchpad (å†å²æ€è€ƒ+è§‚å¯Ÿ)        â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚                       â”‚                             â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚                       â–¼                             â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚ Step 2: è°ƒç”¨ LLM                           â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   llm.bind(stop=["\nObservation"])         â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   ç”Ÿæˆ: Thought + Action + Action Input    â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚                       â”‚                             â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚                       â–¼                             â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚ Step 3: è§£æ LLM è¾“å‡º                       â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   ReActSingleInputOutputParser.parse()     â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â”‚   è¿”å›: AgentAction æˆ– AgentFinish          â”‚   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚                       â”‚                             â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚          â–¼                         â–¼                â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ AgentAction â”‚          â”‚ AgentFinish â”‚         â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ (ç»§ç»­æ‰§è¡Œ)   â”‚          â”‚ (ç»“æŸè¿”å›)   â”‚         â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚          â”‚                        â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚          â–¼                        â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ Step 4: æ‰§è¡Œâ”‚                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ Tool.run()  â”‚                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ è·å–è§‚å¯Ÿç»“æœ â”‚                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚          â”‚                        â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚          â–¼                        â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ Step 5: æ›´æ–°â”‚                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚scratchpad   â”‚                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â”‚ ç»§ç»­å¾ªç¯... â”‚                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                 â”‚  â”‚ â”‚
â”‚                      â”‚  â”‚                                   â–¼                 â”‚  â”‚ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚ â”‚
â”‚  â”‚   æœ€ç»ˆè¾“å‡º    â”‚â—€â”€â”€â”€â”‚  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ è¿”å› output â”‚          â”‚  â”‚ â”‚
â”‚  â”‚(Final Answer)â”‚    â”‚  â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‰ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

#### 1. `create_react_agent` å‡½æ•° - åˆ›å»º ReAct Agent

```16:147:langchain_classic/agents/react/agent.py
def create_react_agent(
    llm: BaseLanguageModel,
    tools: Sequence[BaseTool],
    prompt: BasePromptTemplate,
    output_parser: AgentOutputParser | None = None,
    tools_renderer: ToolsRenderer = render_text_description,
    *,
    stop_sequence: bool | list[str] = True,
) -> Runnable:
    # ... å‚æ•°éªŒè¯ ...
    
    # å…³é”®æ­¥éª¤1: å¡«å…… prompt æ¨¡æ¿å˜é‡
    prompt = prompt.partial(
        tools=tools_renderer(list(tools)),          # å·¥å…·æè¿°
        tool_names=", ".join([t.name for t in tools]),  # å·¥å…·åç§°åˆ—è¡¨
    )
    
    # å…³é”®æ­¥éª¤2: ç»‘å®šåœæ­¢è¯
    if stop_sequence:
        stop = ["\nObservation"] if stop_sequence is True else stop_sequence
        llm_with_stop = llm.bind(stop=stop)
    else:
        llm_with_stop = llm
    
    # å…³é”®æ­¥éª¤3: ä½¿ç”¨é»˜è®¤è§£æå™¨
    output_parser = output_parser or ReActSingleInputOutputParser()
    
    # å…³é”®æ­¥éª¤4: æ„å»º Runnable é“¾
    return (
        RunnablePassthrough.assign(
            agent_scratchpad=lambda x: format_log_to_str(x["intermediate_steps"]),
        )
        | prompt
        | llm_with_stop
        | output_parser
    )
```

**è¿™ä¸ªé“¾çš„æ‰§è¡Œæµç¨‹ï¼š**
1. `RunnablePassthrough.assign` - æŠŠ `intermediate_steps` è½¬æ¢ä¸º `agent_scratchpad` å­—ç¬¦ä¸²
2. `prompt` - å¡«å…… Prompt æ¨¡æ¿
3. `llm_with_stop` - è°ƒç”¨ LLMï¼Œé‡åˆ° `\nObservation` æ—¶åœæ­¢
4. `output_parser` - è§£æè¾“å‡ºä¸º `AgentAction` æˆ– `AgentFinish`

#### 2. ReAct Prompt æ¨¡æ¿ - æ ¸å¿ƒæ ¼å¼

```1:16:langchain_classic/agents/mrkl/prompt.py
PREFIX = """Answer the following questions as best you can. You have access to the following tools:"""

FORMAT_INSTRUCTIONS = """Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [{tool_names}]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question"""

SUFFIX = """Begin!

Question: {input}
Thought:{agent_scratchpad}"""
```

#### 3. `ReActSingleInputOutputParser` - è¾“å‡ºè§£æå™¨

```22:101:langchain_classic/agents/output_parsers/react_single_input.py
class ReActSingleInputOutputParser(AgentOutputParser):
    """è§£æå™¨æœŸæœ›çš„ä¸¤ç§è¾“å‡ºæ ¼å¼:
    
    æ ¼å¼1 - éœ€è¦æ‰§è¡ŒåŠ¨ä½œ:
    ```
    Thought: agent thought here
    Action: search
    Action Input: what is the temperature in SF?
    ```
    
    æ ¼å¼2 - ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ:
    ```
    Thought: agent thought here
    Final Answer: The temperature is 100 degrees
    ```
    """
    
    def parse(self, text: str) -> AgentAction | AgentFinish:
        includes_answer = "Final Answer:" in text
        
        # æ­£åˆ™åŒ¹é… Action å’Œ Action Input
        regex = r"Action\s*\d*\s*:[\s]*(.*?)[\s]*Action\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)"
        action_match = re.search(regex, text, re.DOTALL)
        
        if action_match:
            # è§£æå‡ºå·¥å…·åå’Œè¾“å…¥
            action = action_match.group(1).strip()
            action_input = action_match.group(2).strip(" ").strip('"')
            return AgentAction(action, action_input, text)
        
        if includes_answer:
            # æå–æœ€ç»ˆç­”æ¡ˆ
            return AgentFinish(
                {"output": text.split("Final Answer:")[-1].strip()},
                text,
            )
        
        # è§£æå¤±è´¥æŠ›å‡ºå¼‚å¸¸
        raise OutputParserException(...)
```

#### 4. `AgentExecutor._call` - ä¸»æ‰§è¡Œå¾ªç¯

```1585:1638:langchain_classic/agents/agent.py
def _call(self, inputs: dict[str, str], run_manager: ...):
    """æ ¸å¿ƒæ‰§è¡Œå¾ªç¯"""
    name_to_tool_map = {tool.name: tool for tool in self.tools}
    intermediate_steps: list[tuple[AgentAction, str]] = []
    iterations = 0
    start_time = time.time()
    
    # ä¸»å¾ªç¯
    while self._should_continue(iterations, time_elapsed):
        # Step 1: è°ƒç”¨ Agent è·å–ä¸‹ä¸€æ­¥åŠ¨ä½œ
        next_step_output = self._take_next_step(
            name_to_tool_map, color_mapping, inputs, 
            intermediate_steps, run_manager
        )
        
        # Step 2: æ£€æŸ¥æ˜¯å¦ç»“æŸ
        if isinstance(next_step_output, AgentFinish):
            return self._return(next_step_output, intermediate_steps, ...)
        
        # Step 3: æ›´æ–°ä¸­é—´æ­¥éª¤ï¼ˆåŒ…å«å·¥å…·æ‰§è¡Œç»“æœï¼‰
        intermediate_steps.extend(next_step_output)
        
        iterations += 1
        time_elapsed = time.time() - start_time
    
    # è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°
    return self._action_agent.return_stopped_response(...)
```

#### 5. `format_log_to_str` - æ„å»ºæ€ç»´å†å²

```4:23:langchain_classic/agents/format_scratchpad/log.py
def format_log_to_str(
    intermediate_steps: list[tuple[AgentAction, str]],
    observation_prefix: str = "Observation: ",
    llm_prefix: str = "Thought: ",
) -> str:
    """å°†å†å²æ­¥éª¤è½¬æ¢ä¸º scratchpad å­—ç¬¦ä¸²"""
    thoughts = ""
    for action, observation in intermediate_steps:
        thoughts += action.log       # ä¹‹å‰çš„ Thought + Action + Action Input
        thoughts += f"\n{observation_prefix}{observation}\n{llm_prefix}"
    return thoughts
```

### å››ã€ä¸€æ¬¡å®Œæ•´çš„ ReAct äº¤äº’ç¤ºä¾‹

å‡è®¾ç”¨æˆ·é—®ï¼š"ä»Šå¤©åŒ—äº¬çš„å¤©æ°”å¦‚ä½•ï¼Ÿ"

**ç¬¬1è½®å¯¹è¯ - å‘é€ç»™ LLM çš„å®Œæ•´ Promptï¼š**

```
Answer the following questions as best you can. You have access to the following tools:

search: æœç´¢äº’è”ç½‘è·å–ä¿¡æ¯
calculator: è¿›è¡Œæ•°å­¦è®¡ç®—

Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [search, calculator]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin!

Question: ä»Šå¤©åŒ—äº¬çš„å¤©æ°”å¦‚ä½•ï¼Ÿ
Thought:
```

**LLM è¾“å‡ºï¼ˆé‡åˆ° `\nObservation` åœæ­¢ï¼‰ï¼š**

```
æˆ‘éœ€è¦æœç´¢åŒ—äº¬ä»Šå¤©çš„å¤©æ°”ä¿¡æ¯ã€‚
Action: search
Action Input: åŒ—äº¬ä»Šå¤©å¤©æ°”
```

**è§£æå™¨è§£æç»“æœï¼š**
```python
AgentAction(
    tool="search",
    tool_input="åŒ—äº¬ä»Šå¤©å¤©æ°”",
    log="æˆ‘éœ€è¦æœç´¢åŒ—äº¬ä»Šå¤©çš„å¤©æ°”ä¿¡æ¯ã€‚\nAction: search\nAction Input: åŒ—äº¬ä»Šå¤©å¤©æ°”"
)
```

**æ‰§è¡Œå·¥å…·åå¾—åˆ° Observationï¼š**
```
åŒ—äº¬ä»Šå¤©æ™´æœ—ï¼Œæ°”æ¸©5-15æ‘„æ°åº¦ï¼Œé£åŠ›3çº§
```

---

**ç¬¬2è½®å¯¹è¯ - å‘é€ç»™ LLM çš„ Promptï¼ˆåŒ…å«å†å²ï¼‰ï¼š**

```
Answer the following questions as best you can. You have access to the following tools:

search: æœç´¢äº’è”ç½‘è·å–ä¿¡æ¯
calculator: è¿›è¡Œæ•°å­¦è®¡ç®—

Use the following format:
...ï¼ˆç›¸åŒæ ¼å¼è¯´æ˜ï¼‰

Begin!

Question: ä»Šå¤©åŒ—äº¬çš„å¤©æ°”å¦‚ä½•ï¼Ÿ
Thought:æˆ‘éœ€è¦æœç´¢åŒ—äº¬ä»Šå¤©çš„å¤©æ°”ä¿¡æ¯ã€‚
Action: search
Action Input: åŒ—äº¬ä»Šå¤©å¤©æ°”
Observation: åŒ—äº¬ä»Šå¤©æ™´æœ—ï¼Œæ°”æ¸©5-15æ‘„æ°åº¦ï¼Œé£åŠ›3çº§
Thought:
```

**LLM è¾“å‡ºï¼š**

```
æˆ‘ç°åœ¨çŸ¥é“äº†åŒ—äº¬ä»Šå¤©çš„å¤©æ°”æƒ…å†µã€‚
Final Answer: åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨5åˆ°15æ‘„æ°åº¦ä¹‹é—´ï¼Œé£åŠ›3çº§ã€‚
```

**è§£æå™¨è§£æç»“æœï¼š**
```python
AgentFinish(
    return_values={"output": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œæ°”æ¸©åœ¨5åˆ°15æ‘„æ°åº¦ä¹‹é—´ï¼Œé£åŠ›3çº§ã€‚"},
    log="..."
)
```

---

## ğŸ“ ç¬¬äºŒéƒ¨åˆ†ï¼šTodoList Write Todo å®ç°

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TodoList ReAct Agent å®Œæ•´æµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  ç”¨æˆ·: "å¸®æˆ‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼šæ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼š"                                                   â”‚
â”‚                                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬1è½®äº¤äº’ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                          â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å‘é€ç»™ LLM çš„ Prompt:                                                             â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ You are a helpful TodoList assistant. You have access to the following tools:    â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ add_todo: Add a new todo item. Input should be JSON: {"title": "...",            â”‚   â”‚
â”‚  â”‚           "due_date": "...", "priority": "high/medium/low"}                      â”‚   â”‚
â”‚  â”‚ list_todos: List all todos. No input required.                                   â”‚   â”‚
â”‚  â”‚ complete_todo: Mark a todo as complete. Input should be the todo ID.             â”‚   â”‚
â”‚  â”‚ delete_todo: Delete a todo item. Input should be the todo ID.                    â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ Use the following format:                                                         â”‚   â”‚
â”‚  â”‚ Question: the input question you must answer                                      â”‚   â”‚
â”‚  â”‚ Thought: you should always think about what to do                                 â”‚   â”‚
â”‚  â”‚ Action: the action to take, should be one of [add_todo, list_todos, ...]         â”‚   â”‚
â”‚  â”‚ Action Input: the input to the action                                             â”‚   â”‚
â”‚  â”‚ Observation: the result of the action                                             â”‚   â”‚
â”‚  â”‚ ... (this Thought/Action/Action Input/Observation can repeat N times)             â”‚   â”‚
â”‚  â”‚ Thought: I now know the final answer                                              â”‚   â”‚
â”‚  â”‚ Final Answer: the final answer to the original input question                     â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ Begin!                                                                            â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ Question: å¸®æˆ‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼šæ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼š                                          â”‚   â”‚
â”‚  â”‚ Thought:                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ LLM è¾“å‡º:                                                                         â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ ç”¨æˆ·æƒ³è¦æ·»åŠ ä¸€ä¸ªå¼€ä¼šä»»åŠ¡ï¼Œæ—¶é—´æ˜¯æ˜å¤©ä¸‹åˆ3ç‚¹ã€‚æˆ‘éœ€è¦ä½¿ç”¨ add_todo å·¥å…·æ¥åˆ›å»ºè¿™ä¸ªä»»åŠ¡ã€‚  â”‚   â”‚
â”‚  â”‚ Action: add_todo                                                                  â”‚   â”‚
â”‚  â”‚ Action Input: {"title": "å¼€ä¼š", "due_date": "2025-12-02 15:00", "priority": "high"}â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è§£æå™¨è§£æ (ReActSingleInputOutputParser.parse):                                   â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ æ­£åˆ™åŒ¹é…: r"Action\s*\d*\s*:[\s]*(.*?)[\s]*Action\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ ç»“æœ: AgentAction(                                                                â”‚   â”‚
â”‚  â”‚   tool="add_todo",                                                                â”‚   â”‚
â”‚  â”‚   tool_input='{"title": "å¼€ä¼š", "due_date": "2025-12-02 15:00", "priority": "high"}â”‚   â”‚
â”‚  â”‚   log="ç”¨æˆ·æƒ³è¦æ·»åŠ ä¸€ä¸ªå¼€ä¼šä»»åŠ¡..."                                                 â”‚   â”‚
â”‚  â”‚ )                                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ‰§è¡Œå·¥å…· (AgentExecutor._perform_agent_action):                                    â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ tool = name_to_tool_map["add_todo"]                                               â”‚   â”‚
â”‚  â”‚ observation = tool.run('{"title": "å¼€ä¼š", ...}')                                  â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ å·¥å…·å†…éƒ¨æ‰§è¡Œ:                                                                      â”‚   â”‚
â”‚  â”‚   - è§£æ JSON è¾“å…¥                                                                â”‚   â”‚
â”‚  â”‚   - è°ƒç”¨ TodoStorage.add_todo()                                                   â”‚   â”‚
â”‚  â”‚   - ä¿å­˜åˆ°æ•°æ®åº“/æ–‡ä»¶                                                              â”‚   â”‚
â”‚  â”‚   - è¿”å›: "æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼ID: todo_001, æ ‡é¢˜: å¼€ä¼š, æˆªæ­¢æ—¶é—´: 2025-12-02 15:00"      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ›´æ–° intermediate_steps:                                                          â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ intermediate_steps.append((                                                       â”‚   â”‚
â”‚  â”‚   AgentAction(tool="add_todo", ...),                                              â”‚   â”‚
â”‚  â”‚   "æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼ID: todo_001, æ ‡é¢˜: å¼€ä¼š, æˆªæ­¢æ—¶é—´: 2025-12-02 15:00"              â”‚   â”‚
â”‚  â”‚ ))                                                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ç¬¬2è½®äº¤äº’ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                          â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ„å»º agent_scratchpad (format_log_to_str):                                        â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ ç”¨æˆ·æƒ³è¦æ·»åŠ ä¸€ä¸ªå¼€ä¼šä»»åŠ¡ï¼Œæ—¶é—´æ˜¯æ˜å¤©ä¸‹åˆ3ç‚¹ã€‚æˆ‘éœ€è¦ä½¿ç”¨ add_todo å·¥å…·æ¥åˆ›å»ºè¿™ä¸ªä»»åŠ¡ã€‚  â”‚   â”‚
â”‚  â”‚ Action: add_todo                                                                  â”‚   â”‚
â”‚  â”‚ Action Input: {"title": "å¼€ä¼š", "due_date": "2025-12-02 15:00", "priority": "high"}â”‚   â”‚
â”‚  â”‚ Observation: æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼ID: todo_001, æ ‡é¢˜: å¼€ä¼š, æˆªæ­¢æ—¶é—´: 2025-12-02 15:00    â”‚   â”‚
â”‚  â”‚ Thought:                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å‘é€ç»™ LLM çš„ Prompt (ç¬¬2è½®):                                                      â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ You are a helpful TodoList assistant...                                           â”‚   â”‚
â”‚  â”‚ ...ï¼ˆç›¸åŒçš„ç³»ç»Ÿæç¤ºï¼‰                                                               â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ Question: å¸®æˆ‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼šæ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼š                                          â”‚   â”‚
â”‚  â”‚ Thought:ç”¨æˆ·æƒ³è¦æ·»åŠ ä¸€ä¸ªå¼€ä¼šä»»åŠ¡...                                                 â”‚   â”‚
â”‚  â”‚ Action: add_todo                                                                  â”‚   â”‚
â”‚  â”‚ Action Input: {"title": "å¼€ä¼š", "due_date": "2025-12-02 15:00", "priority": "high"}â”‚   â”‚
â”‚  â”‚ Observation: æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼ID: todo_001, æ ‡é¢˜: å¼€ä¼š, æˆªæ­¢æ—¶é—´: 2025-12-02 15:00    â”‚   â”‚
â”‚  â”‚ Thought:                                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ LLM è¾“å‡º:                                                                         â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ ä»»åŠ¡å·²ç»æˆåŠŸæ·»åŠ åˆ°å¾…åŠåˆ—è¡¨ä¸­ã€‚                                                      â”‚   â”‚
â”‚  â”‚ Final Answer: å·²æˆåŠŸä¸ºæ‚¨æ·»åŠ ä»»åŠ¡"å¼€ä¼š"ï¼Œå®‰æ’åœ¨æ˜å¤©(2025-12-02)ä¸‹åˆ3ç‚¹ï¼Œ               â”‚   â”‚
â”‚  â”‚ ä¼˜å…ˆçº§ä¸ºé«˜ã€‚ä»»åŠ¡IDä¸º todo_001ã€‚                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è§£æå™¨è§£æ:                                                                        â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ æ£€æµ‹åˆ° "Final Answer:" â†’ è¿”å› AgentFinish                                         â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ ç»“æœ: AgentFinish(                                                                â”‚   â”‚
â”‚  â”‚   return_values={"output": "å·²æˆåŠŸä¸ºæ‚¨æ·»åŠ ä»»åŠ¡'å¼€ä¼š'..."},                          â”‚   â”‚
â”‚  â”‚   log="..."                                                                       â”‚   â”‚
â”‚  â”‚ )                                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                                 â”‚
â”‚                                       â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ AgentExecutor._return:                                                            â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚ è¿”å›: {"output": "å·²æˆåŠŸä¸ºæ‚¨æ·»åŠ ä»»åŠ¡'å¼€ä¼š'ï¼Œå®‰æ’åœ¨æ˜å¤©(2025-12-02)ä¸‹åˆ3ç‚¹..."}     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Œæ•´ä»£ç å®ç°

```python
"""
TodoList ReAct Agent å®Œæ•´å®ç°
åŸºäº LangChain ReAct æ¨¡å¼
"""
import json
import uuid
from datetime import datetime
from typing import Optional
from pydantic import BaseModel, Field

from langchain_core.prompts import PromptTemplate
from langchain_core.tools import BaseTool, tool
from langchain_openai import ChatOpenAI

from langchain_classic.agents import AgentExecutor, create_react_agent


# ==================== 1. æ•°æ®æ¨¡å‹ ====================

class TodoItem(BaseModel):
    """å•ä¸ª Todo é¡¹ç›®"""
    id: str = Field(default_factory=lambda: f"todo_{uuid.uuid4().hex[:8]}")
    title: str
    description: str = ""
    due_date: Optional[str] = None
    priority: str = "medium"  # high, medium, low
    completed: bool = False
    created_at: str = Field(default_factory=lambda: datetime.now().isoformat())


# ==================== 2. Todo å­˜å‚¨å±‚ ====================

class TodoStorage:
    """ç®€å•çš„å†…å­˜å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒå¯æ›¿æ¢ä¸ºæ•°æ®åº“ï¼‰"""
    
    def __init__(self):
        self._todos: dict[str, TodoItem] = {}
    
    def add(self, todo: TodoItem) -> TodoItem:
        self._todos[todo.id] = todo
        return todo
    
    def get(self, todo_id: str) -> Optional[TodoItem]:
        return self._todos.get(todo_id)
    
    def list_all(self) -> list[TodoItem]:
        return list(self._todos.values())
    
    def update(self, todo_id: str, **updates) -> Optional[TodoItem]:
        if todo_id in self._todos:
            todo = self._todos[todo_id]
            for key, value in updates.items():
                if hasattr(todo, key):
                    setattr(todo, key, value)
            return todo
        return None
    
    def delete(self, todo_id: str) -> bool:
        if todo_id in self._todos:
            del self._todos[todo_id]
            return True
        return False


# å…¨å±€å­˜å‚¨å®ä¾‹
todo_storage = TodoStorage()


# ==================== 3. å®šä¹‰ Tools ====================

@tool
def add_todo(input_json: str) -> str:
    """
    Add a new todo item to the list.
    
    Input should be a JSON string with the following format:
    {
        "title": "ä»»åŠ¡æ ‡é¢˜ (å¿…å¡«)",
        "description": "ä»»åŠ¡æè¿° (å¯é€‰)",
        "due_date": "æˆªæ­¢æ—¥æœŸï¼Œæ ¼å¼: YYYY-MM-DD HH:MM (å¯é€‰)",
        "priority": "ä¼˜å…ˆçº§: high/medium/low (å¯é€‰ï¼Œé»˜è®¤medium)"
    }
    
    Returns a confirmation message with the created todo ID.
    """
    try:
        data = json.loads(input_json)
        
        if "title" not in data:
            return "é”™è¯¯ï¼šå¿…é¡»æä¾›ä»»åŠ¡æ ‡é¢˜ (title)"
        
        todo = TodoItem(
            title=data["title"],
            description=data.get("description", ""),
            due_date=data.get("due_date"),
            priority=data.get("priority", "medium"),
        )
        
        created = todo_storage.add(todo)
        
        result = f"âœ… æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼\n"
        result += f"   ID: {created.id}\n"
        result += f"   æ ‡é¢˜: {created.title}\n"
        if created.due_date:
            result += f"   æˆªæ­¢æ—¶é—´: {created.due_date}\n"
        result += f"   ä¼˜å…ˆçº§: {created.priority}"
        
        return result
        
    except json.JSONDecodeError:
        return "é”™è¯¯ï¼šè¾“å…¥å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼"
    except Exception as e:
        return f"é”™è¯¯ï¼šæ·»åŠ ä»»åŠ¡å¤±è´¥ - {str(e)}"


@tool
def list_todos(input: str = "") -> str:
    """
    List all todo items in the list.
    
    No input required. Just call this tool to see all todos.
    
    Returns a formatted list of all todos with their details.
    """
    todos = todo_storage.list_all()
    
    if not todos:
        return "ğŸ“‹ å¾…åŠåˆ—è¡¨ä¸ºç©ºï¼Œè¿˜æ²¡æœ‰ä»»ä½•ä»»åŠ¡ã€‚"
    
    result = f"ğŸ“‹ å¾…åŠåˆ—è¡¨ (å…± {len(todos)} é¡¹):\n\n"
    
    for todo in todos:
        status = "âœ…" if todo.completed else "â¬œ"
        priority_emoji = {"high": "ğŸ”´", "medium": "ğŸŸ¡", "low": "ğŸŸ¢"}.get(todo.priority, "âšª")
        
        result += f"{status} [{todo.id}] {todo.title}\n"
        if todo.description:
            result += f"   ğŸ“ {todo.description}\n"
        if todo.due_date:
            result += f"   ğŸ“… æˆªæ­¢: {todo.due_date}\n"
        result += f"   {priority_emoji} ä¼˜å…ˆçº§: {todo.priority}\n\n"
    
    return result


@tool
def complete_todo(todo_id: str) -> str:
    """
    Mark a todo item as completed.
    
    Input should be the todo ID (e.g., "todo_abc12345").
    
    Returns a confirmation message.
    """
    todo_id = todo_id.strip()
    todo = todo_storage.update(todo_id, completed=True)
    
    if todo:
        return f"âœ… ä»»åŠ¡ '{todo.title}' (ID: {todo_id}) å·²æ ‡è®°ä¸ºå®Œæˆï¼"
    else:
        return f"âŒ æœªæ‰¾åˆ° ID ä¸º '{todo_id}' çš„ä»»åŠ¡ã€‚è¯·ä½¿ç”¨ list_todos æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ã€‚"


@tool
def delete_todo(todo_id: str) -> str:
    """
    Delete a todo item from the list.
    
    Input should be the todo ID (e.g., "todo_abc12345").
    
    Returns a confirmation message.
    """
    todo_id = todo_id.strip()
    todo = todo_storage.get(todo_id)
    
    if todo and todo_storage.delete(todo_id):
        return f"ğŸ—‘ï¸ ä»»åŠ¡ '{todo.title}' (ID: {todo_id}) å·²åˆ é™¤ï¼"
    else:
        return f"âŒ æœªæ‰¾åˆ° ID ä¸º '{todo_id}' çš„ä»»åŠ¡ã€‚è¯·ä½¿ç”¨ list_todos æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ã€‚"


@tool
def update_todo(input_json: str) -> str:
    """
    Update an existing todo item.
    
    Input should be a JSON string with the following format:
    {
        "id": "todo_xxx (å¿…å¡«)",
        "title": "æ–°æ ‡é¢˜ (å¯é€‰)",
        "description": "æ–°æè¿° (å¯é€‰)",
        "due_date": "æ–°æˆªæ­¢æ—¥æœŸ (å¯é€‰)",
        "priority": "æ–°ä¼˜å…ˆçº§ (å¯é€‰)"
    }
    
    Returns a confirmation message.
    """
    try:
        data = json.loads(input_json)
        
        if "id" not in data:
            return "é”™è¯¯ï¼šå¿…é¡»æä¾›ä»»åŠ¡ ID"
        
        todo_id = data.pop("id")
        todo = todo_storage.update(todo_id, **data)
        
        if todo:
            return f"âœ… ä»»åŠ¡ (ID: {todo_id}) å·²æ›´æ–°ï¼\n   å½“å‰æ ‡é¢˜: {todo.title}"
        else:
            return f"âŒ æœªæ‰¾åˆ° ID ä¸º '{todo_id}' çš„ä»»åŠ¡ã€‚"
            
    except json.JSONDecodeError:
        return "é”™è¯¯ï¼šè¾“å…¥å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼"
    except Exception as e:
        return f"é”™è¯¯ï¼šæ›´æ–°ä»»åŠ¡å¤±è´¥ - {str(e)}"


# ==================== 4. åˆ›å»º ReAct Agent ====================

def create_todo_agent():
    """åˆ›å»º TodoList ReAct Agent"""
    
    # å®šä¹‰å·¥å…·åˆ—è¡¨
    tools = [add_todo, list_todos, complete_todo, delete_todo, update_todo]
    
    # å®šä¹‰ Prompt æ¨¡æ¿
    template = """You are a helpful TodoList assistant. Help users manage their tasks.

You have access to the following tools:

{tools}

Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [{tool_names}]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Important rules:
1. When adding a todo, always use proper JSON format for the input
2. Always confirm the action result with the user
3. If the user's request is unclear, ask for clarification
4. Be helpful and proactive in suggesting related actions

Begin!

Question: {input}
Thought:{agent_scratchpad}"""

    prompt = PromptTemplate.from_template(template)
    
    # åˆ›å»º LLM
    llm = ChatOpenAI(
        model="gpt-4",
        temperature=0,
    )
    
    # åˆ›å»º ReAct Agent
    agent = create_react_agent(llm, tools, prompt)
    
    # åˆ›å»º AgentExecutor
    agent_executor = AgentExecutor(
        agent=agent,
        tools=tools,
        verbose=True,  # å¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°æ€è€ƒè¿‡ç¨‹
        handle_parsing_errors=True,  # è‡ªåŠ¨å¤„ç†è§£æé”™è¯¯
        max_iterations=10,  # æœ€å¤§è¿­ä»£æ¬¡æ•°
    )
    
    return agent_executor


# ==================== 5. è¿è¡Œç¤ºä¾‹ ====================

def main():
    """è¿è¡Œ TodoList Agent ç¤ºä¾‹"""
    
    agent = create_todo_agent()
    
    # ç¤ºä¾‹1: æ·»åŠ ä»»åŠ¡
    print("=" * 60)
    print("ç¤ºä¾‹1: æ·»åŠ ä»»åŠ¡")
    print("=" * 60)
    result = agent.invoke({
        "input": "å¸®æˆ‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼šæ˜å¤©ä¸‹åˆ3ç‚¹å¼€ä¼šï¼Œä¼˜å…ˆçº§é«˜"
    })
    print(f"\næœ€ç»ˆè¾“å‡º: {result['output']}\n")
    
    # ç¤ºä¾‹2: æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
    print("=" * 60)
    print("ç¤ºä¾‹2: æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡")
    print("=" * 60)
    result = agent.invoke({
        "input": "æ˜¾ç¤ºæˆ‘æ‰€æœ‰çš„å¾…åŠäº‹é¡¹"
    })
    print(f"\næœ€ç»ˆè¾“å‡º: {result['output']}\n")
    
    # ç¤ºä¾‹3: å¤æ‚æ“ä½œ
    print("=" * 60)
    print("ç¤ºä¾‹3: å¤æ‚æ“ä½œ")
    print("=" * 60)
    result = agent.invoke({
        "input": "å…ˆå¸®æˆ‘æ·»åŠ ä¸€ä¸ªä»»åŠ¡'å†™å‘¨æŠ¥'ï¼Œæˆªæ­¢æ—¥æœŸæ˜¯è¿™å‘¨äº”ï¼Œç„¶åæ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡"
    })
    print(f"\næœ€ç»ˆè¾“å‡º: {result['output']}\n")


if __name__ == "__main__":
    main()
```

### è¯¦ç»†æ‰§è¡Œæ—¥å¿—ç¤ºä¾‹

å½“è¿è¡Œ `ç¤ºä¾‹1: æ·»åŠ ä»»åŠ¡` æ—¶ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¯¦ç»†æ—¥å¿—ï¼š

```
> Entering new AgentExecutor chain...

ç”¨æˆ·æƒ³è¦æ·»åŠ ä¸€ä¸ªå¼€ä¼šä»»åŠ¡ï¼Œæ—¶é—´æ˜¯æ˜å¤©ä¸‹åˆ3ç‚¹ï¼Œä¼˜å…ˆçº§ä¸ºé«˜ã€‚æˆ‘éœ€è¦ä½¿ç”¨ add_todo å·¥å…·æ¥åˆ›å»ºè¿™ä¸ªä»»åŠ¡ã€‚é¦–å…ˆæˆ‘éœ€è¦æ„é€ æ­£ç¡®çš„ JSON æ ¼å¼è¾“å…¥ã€‚

Action: add_todo
Action Input: {"title": "å¼€ä¼š", "due_date": "2025-12-02 15:00", "priority": "high"}

Observation: âœ… æˆåŠŸæ·»åŠ ä»»åŠ¡ï¼
   ID: todo_a1b2c3d4
   æ ‡é¢˜: å¼€ä¼š
   æˆªæ­¢æ—¶é—´: 2025-12-02 15:00
   ä¼˜å…ˆçº§: high

Thought: ä»»åŠ¡å·²ç»æˆåŠŸæ·»åŠ åˆ°å¾…åŠåˆ—è¡¨ä¸­ã€‚æˆ‘ç°åœ¨å¯ä»¥ç»™ç”¨æˆ·ä¸€ä¸ªç¡®è®¤çš„å›å¤ã€‚

Final Answer: å·²æˆåŠŸä¸ºæ‚¨æ·»åŠ ä»»åŠ¡"å¼€ä¼š"ï¼
- ä»»åŠ¡ID: todo_a1b2c3d4
- å®‰æ’æ—¶é—´: æ˜å¤©(2025-12-02)ä¸‹åˆ3ç‚¹
- ä¼˜å…ˆçº§: é«˜

æ‚¨è¿˜éœ€è¦æˆ‘å¸®æ‚¨åšä»€ä¹ˆå—ï¼Ÿ

> Finished chain.
```

### æ•°æ®æµæ€»ç»“è¡¨

| é˜¶æ®µ | ç»„ä»¶ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| 1. ç”¨æˆ·è¾“å…¥ | - | è‡ªç„¶è¯­è¨€è¯·æ±‚ | `{"input": "..."}` |
| 2. æ„å»º Scratchpad | `format_log_to_str` | `intermediate_steps` | å†å²å­—ç¬¦ä¸² |
| 3. å¡«å…… Prompt | `PromptTemplate` | tools, tool_names, input, scratchpad | å®Œæ•´ prompt |
| 4. LLM æ¨ç† | `ChatOpenAI` | prompt | Thought + Action + Action Input |
| 5. è§£æè¾“å‡º | `ReActSingleInputOutputParser` | LLM æ–‡æœ¬ | `AgentAction` æˆ– `AgentFinish` |
| 6. æ‰§è¡Œå·¥å…· | `Tool.run()` | action_input | observation å­—ç¬¦ä¸² |
| 7. å¾ªç¯/è¿”å› | `AgentExecutor` | - | ç»§ç»­å¾ªç¯æˆ–è¿”å›ç»“æœ |

---

