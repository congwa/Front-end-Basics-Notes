
# 使用 Pickle 序列化的键值存储  使用 hnswlib 向量数据库  使用 igraph 图数据库 

使用 Pickle 序列化的键值存储  使用 hnswlib 向量数据库  使用 igraph 图数据库 
三个存储组件及其关联关系：

1. **存储组件架构**

```plaintext
BaseGraphRAG
├── state_manager (管理所有存储)
    ├── graph_storage (IGraphStorage - 图数据库)
    ├── entity_storage (HNSWVectorStorage - 向量数据库)
    └── chunk_storage (PickleIndexedKeyValueStorage - 键值存储)
```

2. **各组件功能和关联**：

A. **PickleIndexedKeyValueStorage (键值存储)**
- 主要用途：存储文档块（chunks）
- 关键特性：
```python
@dataclass
class PickleIndexedKeyValueStorage:
    _data: Dict[TIndex, GTValue]           # 存储实际数据
    _key_to_index: Dict[GTKey, TIndex]     # 键到索引的映射
    _free_indices: List[TIndex]            # 空闲索引列表
```
- 存储位置：`kv_data.pkl`

B. **HNSWVectorStorage (向量数据库)**
- 主要用途：存储实体的向量表示，用于相似度检索
- 关键特性：
```python
@dataclass
class HNSWVectorStorage:
    config: HNSWVectorStorageConfig    # HNSW配置
    _index: hnswlib.Index             # 向量索引
    _metadata: Dict[GTId, Dict]       # 元数据存储
```
- 存储位置：
  - 索引：`hnsw_index_{}.bin`
  - 元数据：`hnsw_metadata.pkl`

C. **IGraphStorage (图数据库)**
- 主要用途：存储实体和关系的图结构
- 关键特性：
```python
@dataclass
class IGraphStorage:
    _graph: ig.Graph                  # 图结构
    config: IGraphStorageConfig       # 图配置
```
- 存储位置：`igraph_data.pklz`

3. **数据流和交互**：

```python
# 插入流程
async def async_insert(self, content: str):
    # 1. 文档分块
    chunked_documents = await self.chunking_service.extract(data)
    
    # 2. 存储到键值存储
    new_chunks = await self.state_manager.filter_new_chunks(chunked_documents)
    
    # 3. 提取实体和关系
    subgraphs = self.information_extraction_service.extract(
        documents=new_chunks
    )
    
    # 4. 更新图数据库和向量数据库
    await self.state_manager.upsert(subgraphs=subgraphs, documents=new_chunks)
```

4. **查询流程**：

```python
async def async_query(self, query: str):
    # 1. 从查询中提取实体
    extracted_entities = await self.information_extraction_service.extract_entities_from_query()
    
    # 2. 使用向量数据库检索相关实体
    similar_entities = await self.entity_storage.get_knn()
    
    # 3. 使用图数据库获取关系
    related_nodes = await self.graph_storage.get_node()
    
    # 4. 从键值存储获取相关文档块
    chunks = await self.chunk_storage.get()
```

5. **协同工作方式**：

- **数据插入时**：
  1. 键值存储保存原始文档块
  2. 向量数据库存储实体的嵌入表示
  3. 图数据库维护实体间的关系

- **查询检索时**：
  1. 向量数据库负责相似度检索
  2. 图数据库提供关系遍历
  3. 键值存储提供原始内容

6. **存储同步机制**：

```python
async def insert_start(self):
    # 同步启动所有存储
    await self.chunk_storage._insert_start()
    await self.entity_storage._insert_start()
    await self.graph_storage._insert_start()

async def insert_done(self):
    # 同步提交所有存储
    await self.chunk_storage._insert_done()
    await self.entity_storage._insert_done()
    await self.graph_storage._insert_done()
```

这种设计的优势：
1. 分工明确，各司其职
2. 模块化设计，易于扩展
3. 支持异步操作，提高性能
4. 数据一致性保证