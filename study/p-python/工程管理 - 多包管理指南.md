
# 工程管理 - 多包管理指南

## 项目结构

```bash
my-project/                      # Git 仓库根目录
├── # 根配置
├── pyproject.toml               # uv workspace 根配置
├── pnpm-workspace.yaml          # pnpm workspace 配置
├── package.json                 # 前端根配置
├── uv.lock                      # Python lockfile
├── pnpm-lock.yaml               # 前端 lockfile
├── Makefile                     # 统一命令管理
├── README.md
│
├── # 后端 Python
├── backend/
│   ├── apps/                    # Python 应用
│   │   └── api/
│   │       ├── pyproject.toml
│   │       └── src/
│   │           └── api/
│   │               ├── __init__.py
│   │               └── main.py
│   │
│   └── packages/                # Python 公共包
│       ├── skill-lib/
│       │   ├── pyproject.toml
│       │   └── src/
│       │       └── skill_lib/
│       │           └── __init__.py
│       │
│       └── shared-utils/
│           ├── pyproject.toml
│           └── src/
│               └── shared_utils/
│                   └── __init__.py
│
└── # 前端
    └── frontend/
        ├── apps/                # 前端应用
        │   └── web/
        │       ├── package.json
        │       ├── next.config.js
        │       └── src/
        │
        └── packages/            # 前端公共包
            ├── skill-ui/
            │   ├── package.json
            │   ├── tsup.config.ts
            │   └── src/
            │       └── index.ts
            │
            └── shared-components/
                ├── package.json
                └── src/
                    └── index.ts
```

---

## 配置文件

### 根目录

#### `pyproject.toml`（uv workspace）

```toml
# my-project/pyproject.toml

[tool.uv.workspace]
members = ["backend/apps/*", "backend/packages/*"]

[tool.uv]
dev-dependencies = [
    "pytest>=8.0",
    "ruff>=0.4",
]
```

#### `pnpm-workspace.yaml`

```yaml
# my-project/pnpm-workspace.yaml

packages:
  - 'frontend/apps/*'
  - 'frontend/packages/*'
```

#### `package.json`

```json
{
  "name": "my-project",
  "private": true,
  "scripts": {
    "dev:web": "pnpm --filter web dev",
    "build:web": "pnpm --filter web build",
    "dev:ui": "pnpm --filter @myorg/skill-ui dev"
  },
  "devDependencies": {
    "typescript": "^5.4.0"
  }
}
```

---

### 后端配置

#### `backend/apps/api/pyproject.toml`

```toml
[project]
name = "api"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = [
    "skill-lib",
    "shared-utils",
    "fastapi>=0.110",
    "uvicorn>=0.29",
]

[tool.uv.sources]
skill-lib = { workspace = true }
shared-utils = { workspace = true }

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

#### `backend/packages/skill-lib/pyproject.toml`

```toml
[project]
name = "skill-lib"
version = "0.1.0"
description = "技能管理库"
requires-python = ">=3.10"
dependencies = [
    "pydantic>=2.0",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

---

### 前端配置

#### `frontend/apps/web/package.json`

```json
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "dependencies": {
    "@myorg/skill-ui": "workspace:*",
    "@myorg/shared-components": "workspace:*",
    "next": "^14.2.0",
    "react": "^18.3.0",
    "react-dom": "^18.3.0"
  }
}
```

#### `frontend/packages/skill-ui/package.json`

```json
{
  "name": "@myorg/skill-ui",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsup src/index.ts --format esm --dts",
    "dev": "tsup src/index.ts --format esm --dts --watch"
  },
  "devDependencies": {
    "tsup": "^8.0.0",
    "typescript": "^5.4.0"
  },
  "peerDependencies": {
    "react": ">=18.0.0"
  }
}
```

#### `frontend/packages/skill-ui/tsup.config.ts`

```typescript
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  dts: true,
  clean: true,
  external: ['react', 'react-dom'],
})
```

---

## Makefile

```makefile
# my-project/Makefile

.PHONY: install dev dev-api dev-web test lint build clean

# ============ 安装 ============

install:
	uv sync
	pnpm install

# ============ 开发 ============

# 同时启动前后端
dev:
	@make -j3 dev-api dev-web dev-ui

# 后端 API
dev-api:
	uv run --package api uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

# 前端 Web
dev-web:
	pnpm --filter web dev

# 前端 UI 包（watch 模式）
dev-ui:
	pnpm --filter @myorg/skill-ui dev

# ============ 测试 ============

test:
	uv run pytest
	pnpm test

test-api:
	uv run pytest backend/

test-web:
	pnpm --filter web test

# ============ 代码检查 ============

lint:
	uv run ruff check backend/
	pnpm lint

format:
	uv run ruff format backend/
	pnpm format

# ============ 构建 ============

build:
	@make build-api build-web

build-api:
	uv build --package api

build-web:
	pnpm --filter @myorg/skill-ui build
	pnpm --filter web build

# ============ 清理 ============

clean:
	rm -rf .venv dist node_modules
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type d -name "node_modules" -exec rm -rf {} +
	find . -type d -name ".next" -exec rm -rf {} +
	find . -type d -name "dist" -exec rm -rf {} +
```

---

## 常用命令

### 安装依赖

```bash
make install
# 等同于:
# uv sync
# pnpm install
```

### 开发模式

```bash
# 同时启动前后端
make dev

# 或分别启动
make dev-api     # 后端 API (http://localhost:8000)
make dev-web     # 前端 Web (http://localhost:3000)
make dev-ui      # UI 包 watch 模式
```

### 添加依赖

```bash
# 后端
uv add requests --package api              # 给 api 添加
uv add pydantic --package skill-lib        # 给公共包添加
uv add pytest --dev                        # 添加开发依赖

# 前端
pnpm add axios --filter web                # 给 web 添加
pnpm add zod --filter @myorg/skill-ui      # 给公共包添加
pnpm add -D vitest                         # 添加开发依赖（根目录）
```

### 在应用中使用公共包

```python
# backend/apps/api/src/api/main.py
from skill_lib import SkillManager
from shared_utils import helper
```

```typescript
// frontend/apps/web/src/app/page.tsx
import { SkillCard } from '@myorg/skill-ui'
import { Button } from '@myorg/shared-components'
```

---

## 开发工作流

### 新增 Python 公共包

```bash
# 1. 创建目录
mkdir -p backend/packages/my-lib/src/my_lib
touch backend/packages/my-lib/src/my_lib/__init__.py

# 2. 创建配置
cat > backend/packages/my-lib/pyproject.toml << 'EOF'
[project]
name = "my-lib"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = []

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
EOF

# 3. 同步
uv sync
```

### 新增前端公共包

```bash
# 1. 创建目录
mkdir -p frontend/packages/my-ui/src
touch frontend/packages/my-ui/src/index.ts

# 2. 创建配置
cat > frontend/packages/my-ui/package.json << 'EOF'
{
  "name": "@myorg/my-ui",
  "version": "0.1.0",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsup src/index.ts --format esm --dts",
    "dev": "tsup src/index.ts --format esm --dts --watch"
  },
  "devDependencies": {
    "tsup": "^8.0.0",
    "typescript": "^5.4.0"
  }
}
EOF

# 3. 同步
pnpm install
```

---

## 将公共包提取为独立仓库

当公共包需要被其他项目使用时：

### Python 包

```bash
# 1. 创建独立仓库
cd backend/packages/skill-lib
git init
git add .
git commit -m "init: skill-lib"
git remote add origin git@github.com:your-org/skill-lib.git
git push -u origin main
git tag v0.1.0
git push --tags
```

```toml
# 其他项目使用
[project]
dependencies = ["skill-lib"]

[tool.uv.sources]
skill-lib = { git = "https://github.com/your-org/skill-lib", tag = "v0.1.0" }
```

### 前端包

```bash
# 1. 确保构建产物已提交
cd frontend/packages/skill-ui
pnpm build
git init
git add .
git commit -m "init: skill-ui"
git remote add origin git@github.com:your-org/skill-ui.git
git push -u origin main
git tag v0.1.0
git push --tags
```

```json
// 其他项目使用
{
  "dependencies": {
    "@myorg/skill-ui": "github:your-org/skill-ui#v0.1.0"
  }
}
```

---

## .gitignore

```gitignore
# Python
__pycache__/
*.py[cod]
.venv/
dist/
*.egg-info/

# Node
node_modules/
.next/
frontend/**/dist/

# IDE
.idea/
.vscode/
*.swp

# 环境
.env
.env.local
.env.*.local

# 系统
.DS_Store
Thumbs.db

# Lockfiles（保留）
# !uv.lock
# !pnpm-lock.yaml
```

---

## 环境变量

```bash
# .env.example（提交到 git）
DATABASE_URL=postgresql://user:pass@localhost:5432/db
NEXT_PUBLIC_API_URL=http://localhost:8000

# .env.local（不提交）
DATABASE_URL=postgresql://user:pass@localhost:5432/mydb
NEXT_PUBLIC_API_URL=http://localhost:8000
```

---

## Docker 开发环境（可选）

```yaml
# docker-compose.yml

version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app/backend
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/app

  web:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app/frontend
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: app
    ports:
      - "5432:5432"
```

---

## 命令速查表

| 操作 | 命令 |
|------|------|
| 安装所有依赖 | `make install` |
| 启动全栈开发 | `make dev` |
| 只启动后端 | `make dev-api` |
| 只启动前端 | `make dev-web` |
| 运行测试 | `make test` |
| 代码检查 | `make lint` |
| 格式化代码 | `make format` |
| 构建所有 | `make build` |
| 添加后端依赖 | `uv add <pkg> --package <app>` |
| 添加前端依赖 | `pnpm add <pkg> --filter <app>` |

---

## 参考链接

- [uv Workspaces](https://docs.astral.sh/uv/concepts/workspaces/)
- [pnpm Workspaces](https://pnpm.io/workspaces)
- [tsup 文档](https://tsup.egoist.dev/)
- [Next.js 文档](https://nextjs.org/docs)
