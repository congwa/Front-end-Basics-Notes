# 进程

进程是一个具有一定独立功能的程序关于某个数据集合的一次运行活动，它是进行系统资源分配、调度的一个独立单位。

进程的特征

a． 动态性：程序的一个执行过程，运动中的程序。
b． 并发性：建立进程的程序是可并发执行的。
c． 异步性：并发程序相互制约。
d． 独立性：在一个数据集上，作为一个基本单位，具有独立性。
e． 结构性：每个进程都由其相对应的数据结构及某独立表项。

引入进程的利弊

利：多道程序并行执行，改善了系统资源的利用率，提高了系统的吞吐量、

弊：1）空间开销

2）时间开销

## 进程的状态及转换

### 进程的3种状态

就绪、运行、阻塞

![进程](/study/imgs/%E8%BF%9B%E7%A8%8B.png)

### 进程的实体

进程控制块（Process Control Block——PCB）

PCB 时系统为描述和控制进程的运行而为每个进程定义的一个数据结构，PCB 中记录了操作系统所需全部的关于进程的描述和控制信息，它是进程存在的唯一标志。

PCB 结构（内容）标识信息、调度信息、处理机信息、控制信息

PCB 的组织方式（根据不同的状态来组织）：索引表结构，或链接表结构。

### 进程控制

进程控制的任务就是通过控制进程的状态的变化，使各个进程有条不紊地推进，从而实现对系统中全部进程的有效管理。

进程控制是由进程使用操作系统提供的一组系统调用来实现的，且这些系统调用都具有原语的性质，故也称为进程控制原语。

原语：是执行一定功能的程序段，它的执行不可中断，好像执行一条指令一样。原语具有原子操作性，即一个操作的所有动作，要么全做，要么全不做。这种原子性通过屏蔽中断来实现。


- 创建原语 - 为被创建的进程建立一个 PCB，并填入相应的初始项。
- 撤销原语 - 收回被撤销的进程占用的所有资源，并撤销它的 PCB。
    >撤销进程原语应由父进程或祖先进程发出。进程一般不能自己撤销自己 。进程一般不能自己撤销自己。
- 阻塞原语 - 将进程有执行状态或其他状态转为阻塞状态。
- 唤醒原语 - ：由"发现者"进程将处于阻塞状态的进程有阻塞状态变为就绪状态。（发现者进程与被唤醒的进程之间存在制约关系，或者是监视事件发生地系统进程）

## 进程状态和进程控制

操作系统进程管理的核心任务是为了多个进程合理地分配处理机资源，这就是处理机调度。因为处理机调度是面向进程的，所以又称进程调度。

### 进程调度的功能
在系统运行过程中，由于多个进程需要轮流使用处理机，所以完成分配处理机任务的进程调度是系统中最频繁的工作，也是操作系统核心的重要组成部分。

进程调度的主要功能是：

1. 记录：记录当前进程的情况，如进程名、指令计数器、状态寄存器及所有通用寄存器等现场信息，将这些信息记录在它的进程控制块中。
2. 确定哪一个：根据一定的调度算法，确定就绪队列中哪一个进程能获得处理机，以及占有多长时间
3. 回收和分配处理机。当前进程转入适当的状态后，系统回收处理机，然后把处理机分配给算法选中的下一个进程。



### 进程调度性能标准

在系统完成进程调度时，最关键的是调度算法。操作系统的设计目标和工作效率主要进程调度算法性能决定。

面向用户的指标：周转时间短、响应时间快、截止时间的保证、优先权准则。

1. 响应时间 从用户提出请求，到系统首次产生响应所经历的时间。
2. 周转时间 从用作业提交给系统开始，到作业完成为止。
3. 截止时间 某任务必须开始执行的最迟时间。
4. 运行时间 处理器+I/O，指进程获得处理器，处于 CPU-I/O 的执行期

面向系统的指标：系统的吞吐量高、处理机的利用率好、各类资源的平衡利用


### 进程调度方式

把处理机分配给一个进程使用时，通常有两种方式

- 非剥夺方式： 不能从正在运行的进程夺走处理器控制权，除非它运行完毕或因某种原因 阻塞。
- 剥夺方式： 按某种原则，将正在运行的进程强撤销，并将处理器分配给其他就绪进程。
    剥夺原则:
      1. 优先级原则;
      2. 短进程优先原则;
      3. 时间片原则;
      4. 强制性剥夺；


### 进程调度算法


进程调度算法又称调度策略，它是指在就绪状态的进程中，按照什么原则选择一个进程，并把处理机分配给该进程使用。
主要解决的两个问题:

1. 选择方式:选择哪个进程(随算法不同而不同);
2. 调度方式:选中它以后，如何给它分配 CPU，及其占用 CPU 的时间(剥夺、非剥夺);
#### 先进先出(FIFO)

- a. 按照进程进入就绪队列的先后次序来分配处理机 
- b. 非剥夺方式调度方法
- c. 优缺点
#### 短执行进程优先(SCBF)
- a. 按照就绪队列中的进程预期执行时间的长短来分配处理机
- b. 剥夺方式调度方法
- c. 优缺点
#### 优先级调度(最常用)
- a. 按照就绪队列中的进程的优先级的高低来分配处理机(优先权:静态、动态) 
- b. 剥夺/非剥夺方式调度方法
- c. 优缺点
#### 时间片轮转法
系统将所有就绪进程按到达时间的先后顺序排成一个队列，依次轮流调度各个进程，调度算法从队列头选择一个进程执行，且仅执行一个时间片，当时用完一个时间片后，释放 CPU，并加 入到就绪队列尾部，等待继续调度。
    难点和关键:时间片的长短的选择。
#### 多级队列反馈调度算法

---


### 进程间的同步和互斥

进程间存在两种制约关系

1. 直接相互制约
    > 进程合作-同步关系(进程的推进速度之间的制约-进程间的通讯)
2. 间接相互制约
    > 资源共享-互斥关系

---
几个概念

1. 临界资源-一次只允许一个进程使用的资源
2. 临界区： 访问这段临界资源的那段程序
3. 进程互斥：多个进程在共享临界资源时候的相互制约关系
4. 进程同步：系统中有多个进程共同完成一个任务，这些进程之间存在着直接制约关系，每一个进程要依赖其它进程的结果才能继续运行。共同完成一个任务的若干进程，成为合作进程。

---
进程同步和互斥的区别

1. 互斥进程在单独运行时可以获得正确的结果。同步进程不能单独运行。
2. 互斥进程不能规定执行的先后顺序，同步进程必须按照严格的顺序执行
3. 互斥进程不知道对方的存在。同步进程不仅知道对方的存在，还要通过和其他进程的通讯来达到相互的协调。
---

同步机制必须遵循以下原则
1. 空闲让进
2. 忙则等待
3. 有限等待，避免死等（死锁）
4. 让权等待： 退出临界区，立即让出处理机，让位给等待进程。避免"忙等"
---


### P、V操作

#### 信号量

信号量 S(Semaphore)是一个记录性变量

初始值:表示系统中某类资源的数目
- >0 :表示系统当前可用的该类资源的数目
- <=0 :其绝对值表示系统中因请求该类资源而被阻塞的 进程数目

除初始化之外，信号量仅能由 P、V 两条原语，即 P、V 两种操作来改变

- 使用信号量来实现进程互斥
    >用信号量解决几个进程互斥进入临界区的问题，几个进程共享一个公用信号量 mutex(互斥信号量)。
- 使用信号量来模拟进程之间的同步
    > 设立与资源相关的私有信号量(资源信号量)。

    1. 生产者消费者问题
    2. 读者写者问题
    3. 哲学家进餐问题

### 进程通讯

#### 进程通讯机制

引发进程之间的交换信息称之为进程通讯。 进程间的互斥与同步就是一种通讯的方式。

通讯方式
1. 高级通讯。 交换信息量大，采用缓冲、管道、信箱、共享区等方式。
2. 低级通讯。 交换信息量小，通常采用变量、数组的方式。例如进程同步和互斥P、V操作。

根据实施方式和数据存取方式可分为三类。

1. 共享存储器系统： 相互通讯的进程共享某些数据结构和共享存储区（如寄存器、数组等）
2. 消息传递系统
3. 管道通讯系统- 共享文件，基于文件系统，用一个打开的共享文件连接两个通讯的进程。（以自然字符流方式读写）

#### 消息通讯

把需要在进程中传递的**一组信息**看做一个消息。在系统中设置一个**存放消息的存储区域**，称为消息缓冲区。它可以同事存储一定数量的消息。

格式

发送者： 发送者|消息长度|消息正文
消息缓冲区： 发送者|消息长度|消息正文| next->指向下一个消息缓冲区的指针
系统中每个进程都设置一个消息队列，进程的 PCB 中设置一个指向其缓冲队列的指针。对该队列的操作要遵循同步互斥原则。

#### 信箱通讯

信箱是一种公共的存储区，是通讯的一种中间体。

组成

信箱头： 描述信箱  - 信箱名称、信箱大小、信箱方向以及拥有该信箱的进程名等。
信箱体： 存放消息 -由若干格子组成，每个格子放一信件。（格子数目及大小在创建信箱时确定

- 单向信箱-只发不答
- 双向信箱-即发也收
- 公用信箱-与多个进程通讯(按优先级处理)

### 死锁

所谓死锁，是指多个进程因竞争资源而造成的一种僵局，若无外力作用，这些进程都无法向前推进，死锁是计算机系统和进程所处的一种状态。

---
死锁产生的必要条件

1. 互斥条件
2. 不剥夺条件
3. 请求与保持条件
4. 循环保持条件（进程资源图）：存在一种进程资源的循环等待。

死锁的预防

死锁预防：设置某些条件，破坏产生死锁的必要条件中的一个或多个即可。
 
1. 破坏互斥条件：（应保证对临界资源的互斥访问，故不大可能实现）
2. 破坏不剥夺条件：当进程资源请求不能立即满足时，必须释放所有已获得的资源。
3. 破坏请求与保持条件：静态地一次性分配资源
4. 破坏循环等待条件：有序资源分配法。
5. 对资源进行编号： 进程申请资源时，必须以编号递增方向申请

死锁的避免

死锁的避免：在资源的动态分配过程中，用某种方法防止系统进入不安全状态。
> 银行家算法及安全性算法

系统的安全状态和不安全状态
- 安全状态： 在某个时刻，系统能按某种顺序，如〈P1 ， P2 ，┉ Pn 〉来为每个进程分配需要的资源，直至最大需求，是每个进程都能顺利地完
成。则称此时的系统状态为安全状态。〈P1 ， P2 ，┉ Pn 〉为安全序列。
- 不安全状态： 在某个时刻，系统不存在这样一个安全序列，则称此时的系统状态为不安全状态。

---
死锁的检测

死锁定理：S 为死锁状态的充分条件是，当且仅当 S 状态的资源分配表是不可完全简化的。利用资源分配图，对其进行简化。 

- 可完全简化 -> 不死锁
- 不可完全简化 -> 死锁（死锁定理）
简化方法：寻找过程资源图中即不孤立又不阻塞的节点（进程节点）删去请求边和分配边。

具体如下：
1. 在资源分配表中，找一个即不阻塞也非独立的进程点 Pi，在顺利情况下，Pi 可获得所需资
源而继续执行，直至运行完毕，再释放其占有的所有资源
2. P1 释放资源后，使 P2 获得资源而继续运行， P2 完成后又释放出所有的全部资源。
3. 在进行一系列的简化后，若能消去图中所有边，使所有进程都成为孤立点。则称该图可完全
简化，否则称该图为不可完全简化。

就是所有资源都按照批次分配给进程了（去边），去边后，进程是孤立的。说明没有死锁

---
### 死锁的解除

将系统从死锁状态解脱出来，有两种方法：
1. 资源剥夺法（抢占）：当发生死锁后，从其他进程剥夺足够数量的资源给死锁进程，以解除死
锁状态。
2. 撤销进程法（终止）：采用强制手段，从系统中撤销一个或部分死锁进程，并剥夺这些进程的
资源，供其他死锁进程使用。

注： 要么让这个进程用，要么就杀掉这个进程给别人的进程用，别一直在这等了。