# 存储管理

## 存储管理的目的和功能

1. 存储管理的目的
    - 为多道程序的并发执行提供良好的环境，使每道程序都能在不受干扰的环境中运行。
    - 便于用户使用存储器，是用户从存储器的分配、保护和共享等繁琐的事务中解脱出来
    - 提高存储器的利用率，以提高系统的吞吐量
    - 从逻辑上扩充内存空间，可使大的程序能咋绩效的内存空间运行或允许更多的程序并发执行

2. 存储管理的主要功能
    主存储器的存储空间一般分为两部分： 一部分是系统区，用于存放操作系统的程序和数据；另一部分是用户区，用于存放应用程序与用户的程序和数据


存储管理主要是对用户区进行管理

1. 内存分配
    - 为每道程序分配内存空间
    - 提高存储器的利用率，以减少不可用的存储空间
    - 允许正在运行的程序申请附加内存空间，以适应程序或数据动态增长的需求

    为此，存储分配机制应该具有以下功能
    - 几率每个存储区的状态，作为内存分配的依据
    - 能动态的分配内存：指的是在进行运行期间，根据系统或用户的请求，分配其所需要的内存空间，并修改相应的空间存储区表
    - 及时回收系统或用户进程释放的存储区 

2. 内存保护
    内存保护的任务是确保每道程序都在自己的内存空间运行，互不干扰
    - 不访问 os 的任何部分，包括程序区或数据区
    - 执行中的进程不会转移到其他进程的程序中去执行
    - 未经特殊安排，不能访问其他进程中的数据，若在执行中发生了上述情况，系统应能立即抛弃这样的指令。

    述检查需要硬件完成，使用软件不仅会显著增减 cpu 开销，且大大降低了进程的运行速度。

3. 内存共享
4. 地址映射（作业从源程序装入的过程）
5. 内存扩充
    内存扩充的任务是从逻辑上来扩充内存容量，是用户认为系统所拥有的内存空间比实际的空间大。为实现此任务，系统必须具有下述功能
    - 请求调入功能
    - 置换功能

    虚拟存储器——os 把主存和辅存两者融为一体，为用户提供一个超过实际主存容量的存储器。其容量由计算机的地质结构来决定。

---

### 地址的重定位

名字空间：用户在使用汇编语言或高级语言编制作业的源程序时，一般要使用符号名来指定程序转移的目的地、子程序的入口地址以及要访问的数据等在作业中的位置。因此这个作空间称为名字空间。


作业的逻辑地址空间（相对地址空间）：源程序经过汇编或编译后，形成目标程序，每个目标程序都是以 0 为基址顺序进行编址的，原来用符号名访问的单元用具体的数据——单元号取代。这样生成的目标程序占据一定的地址空间，称为作业的逻辑地址空间，简称逻辑空间。在逻辑空间中每条指令的地址和指令中要访问的操作数地址统称为逻辑地址。


作业的物理地址空间（绝对地址空间）：内存是由若干个存储单元组成的，所有存储单元顺序编号，每个存储单元有一个编号，这种编号可唯一标识一个存储单元，称为内存地址（或物理地址）。程序装入内存后，它们占用的主存区域是由绝对地址来确定指令和数据的位置的，通常把这些绝对地址的集合形成的作业空间称为作业的物理地址空间（绝对地址空间）。

逻辑地址和物理地址。这两者在多道程序环境下是不一致的，因此存储管理必须提供地址映射功能（重定位），用于把逻辑地址转换为物理地址。

静态重定位：有装配程序来完成。物理地址=起始地址+逻辑地址

动态重定位：在程序执行过程中，由硬件地址映射机构来完成。基地址寄存器BR，虚地址寄存器 VR，内存地址 MR=BR+VR

--- 

## 分区存储管理

单道系统：单一连续存储管理。

多道系统：最简单的方法是将内存用户区划分成若干区域，每个区域分配给一个用户作业，把用户作业一次性全部装入内存，并限定它们只能在自己的区域内运行。


### 固定分区管理

将内存空间划分为若干分区（划分原则由系统操作员或 OS 确定）每个分区中驻留一道程序，这些分区的长度可以不同，但分区的个数和每个分区的长度、位置是固定的。

分配策略

- 在调度作业时，存储器管理根据所需量在分区说明表中找出一个足够大的分区分配它，然后用重定位装配程序装入它。如果找不到合适得分区，则通知作业调度模块，另外选择一个作业
- 分配：依次查找分区说明表中的信息，将分区大小满足作业请求容量，并且使用状态为空闲的第一个分区分配给该作业。同时将该分区的状态改为已使用。如图。
- 回收：作业运行完毕后，将释放的分区收回，设分区使用状态为空闲。

优点：能实现多个作业共享内存，保证多道运行、数据结构简单，分配回收算法容易实现等；

缺点：内存利用不充分，小作业占用大分区，造成内碎片现象；作业的大小受到分区大小严格限制；

内碎片：在固定分区方式中，一个分区分配给作业后，分区中未使用的空间区称为内碎片，又称内
零头。


### 可变分区管理


量体裁衣： 根据作业大小动态地划分分区，使分区大小正好适应作业的需要。克服了内碎片。

主存占有表和空闲说明表（链）

分区说明表：记录占用内存分区的情况；

空闲说明表（空闲分区链）：将内存中空闲分区单独构成一个空闲分区表和空闲分区链；



分配策略：主要问题：分配、回收

1. 首次适应算法（FF）：按始地址升序排列。从链首开始分配。
    分配：从空闲分区表（空闲分区链）首部开始顺序查找，直到找到第一个能满足其大小要求的空闲地址为止。

    优点：算法简单，查找速度快，大作业易满足要求。
2. 最佳适应算法（BF）：按分区大小递增的顺序排列
    从空闲分区表（链）首开始查找，直到找到第一个能满足其大小要求的空闲地址为止。

    注意：此算法看起来最佳，其实不然
3. 最坏适应算法（WF）按分区大小递减的顺序排列。
    总是把空闲链中的第一个分区，即将最大的空闲分区分配给作业

    缺点：大作业难以满足要求。


分区回收

当进程运行完毕释放内存时，系统根据释放区的首址，从空闲链中找到相应的插入点，此时可能出现以下四种情况

![四种情况](/study/imgs/huishou.png)

1. 不再为回收区分配新表项，而只需修改 F1 的大小。
2. 用回收区的首址作为新空闲区的首址，大小为两者之和。
3. 将三个分区合并，区 F1 的首址，取消 F2 的表项
4. 新建一个表项。

外碎片：主存中的一个空闲区域在分配给作业后，一般总是剩余一个更小的空闲区。当这样的小分区不能再装入一个作业时，即不能被利用时，它们也成为主存碎片，这样的分区在作用使用的分区之外，所以称为外碎片。

内存紧凑技术（拼接技术）：通过移动各个作业分区的存储位置，把多个外碎片拼接成一个较大的空闲区，从而可以用于存放另一个新的作业。

采用动态重定位技术，一个作业在内存中移动后，只要改变重定位寄存器的内容即可

总结：回收后，合并表项


### 分区管理存储保护

存储保护是为了防止一个作业有意或无意地破坏操作系统或其他作业。

1. 界限寄存器保护（上下界保护法）（上、下限）（PCB）
    把作业 X 分配在 60K 到 124K 的一个分区内，当调度到该作业在 CPU 上执行时，由 OS 把这对寄存器分别设置成 60K 和 124K。在作业运行过程中形成的每一个访问地址，与这两个寄存器的值比较，进行地址有效性检验，发现非法访问时产生中断。

2. 基址，限长寄存器法（基址、限长）
    限长寄存器中的值代表可以使用的最大地址位移量（即相对地址或逻辑地址），基址寄存器用以存放运行作业的起始地址。


3. 保护键法（锁、钥匙）（状态子 PSW）
    对每个分区分配一个唯一的保护健，它是一个 N 位的二进制代码，相当于该分区的一把锁，而在程序状态寄存器 PSW 种，设置有保护键字段，它相当于一把钥匙，在执行存储访问指令时，先要检查被访问的单元所在分区的锁和钥匙是否相符

### 分页存储


### 纯分页存储管理

分页存储管理，把进程的地址空间划分为大小相等的片段，成为页或页面。相应地，内存空间也分成与页面相同大小的若干块，成为物理快或帧。

页面大小通常在 512k~4k，大小必须适中。

若页面太小，一方面课时内存碎片小，减少了内存碎片的总空间，有利于提高内存的利用率；但另一方面，也会使每个进程要求较多的页面，从而引起页表过长，占用大量内存；此外，还会降低页面换进换出的效率。若选择较大的页面虽然可减少页表的长度，提高页面换进换出的效率，但却又会使页面碎片增大。因此，页面大小应选择适中。

### 页表

页表——os 为每个进程建立一张页面与物理块号的对照表，以便实现地址映射；

### 快表

如果把页表全部放在内存，那么存取一个数据时，至少要访问二次内存。一次是访问页表，形成实际内存地址；另一次是根据形成的内存地址存取数据。显然，这比通常执行指令的速度要慢得多，使计算机的运行速度几乎降低一半。

应用联想存储器和页表相结合的方式，可有效地提高系统动态地址转换的速度，是一种行之有效的方法。这个联想存储器称为快表。


### 存储扩充技术

#### 覆盖技术

覆盖是指一个作业的若干程序段，或几个作业的某些部分共享某一个存储空间。


#### 交换技术

对换——指把内存中占时不能运行的进程或暂时不用的程序和数据换出到外存上，以腾出足够的内存空间，把已具备运行条件的进程或进程所需要的程序和数据，换入内存。


#### 虚拟存储技术


局部性原理（principle of locality）：在一个作业运行的某一段时间，它所访问的地址空间往往只集中在某几页 ，它所访问的地址空间往往只集中在某几页，而不是整个程序的所有部分都具有平均的 ，而不是整个程序的所有部分都具有平均的访问概率，这种现象称为局部性原理 ，这种现象称为局部性原理。

当一个作业的地址空间很大时，不能别全部装入内存，但基于局部性原理，允许只将当前要运行的那部分程序和数据先装入内存便启动运行，其余部分仍驻留在外存上，在需要时，在通过调入功能和置换功能将其调入内存

虚拟存储器是只具有请求调入功能和置换功能，能从逻辑上对内存容量进行扩充的一种存储器系统

在多道系统中使用虚拟存储技术，不管物理内存空间多大，系统都可以为每个用户的作业提供很大的独立的虚拟空间。例如 linux 操作系统中可以为每个用户作业提供高达 4G 的虚拟空间

虚拟存储空间中的地址称为虚拟地址。虚拟地址空间大小由虚拟地址的长度决定。

由于虚拟空间比物理内存的容量大的多，所以系统提供的虚拟地址的长度大于主存的绝对地址的长度，例如在80x86 中绝对地址是 32 位的，而虚拟地址是 46 的。

虚拟存储器的特征
1. 多次性
2. 对换性
3. 离散性：多次性和对换

#### 请求式分页存储管理

1. 页表
    在请求分页系统中的页表，时在分页系统的页表的基础上增加如下几项：
    - 页号
    - 状态位
    - 访问字段
    - 修改位
    - 外存始址
  
2. 缺页中断和地址映射过程 
3. 页面淘汰算法
    - 优化 or 最佳淘汰算法（OPT）淘汰将永不再使用的页面，或最长时间内不再访问的页面。（无法实现，仅作为标准）
    - 最近最就不用算法（LRU:Least Recently Used Replacement）当需要置换一页面时，选择在最近一段时间内最久不用地页面予以淘汰。
    - 近似 LRU 算法— NRU（not Recently Used）
    - FIFO 算法：淘汰最先进入内存的页面，即在内存中驻留时间最长的页面。


#### 分段存储管理

从固定分区到可变分区，进而又发展到分页系统的原因，主要都是为了提高内存利用率，然而，分段存储管理方式的引入，则主要是为了满足以下的一系列要求


1. 地址结构
    分段系统，作业的地址空间（二维）由若干逻辑分段组成，每个段是一组逻辑意义完整的信息集合。每段都有自己的名字，且每段都是首地址为 0 的连续的一维地址空间。

2. 段表
    分段式存储管理以段为单位进行内存分配，每段分配一个连续的内存区，各段之间的内存不一定连续，且各个内存区也不等长。内存的分配和释放随需要动态进行。在将一个进程的各个段离散地放入内存和不同的物理区中后，为能使程序正确运行，即能从物理内存中找出每个逻辑段对应的位置，需要在系统中为每个进程建立一张段映射表，简称"段表"(SMT: segment mapping table)。每个段在段表中占有一个表项，其中记录了该段在内存中的起始地址、段的长度。段表可实现从逻辑段到物理内存的映射
3. 地址变换机构
    为了实现从进程的逻辑地址到物理地址的变换功能，在系统中设置了段表寄存器，用于存放段表的始址和段表的长度。

    与页式管理相同，段式管理时的地址变换过程必须经过二次以上的内存访问。即首先访问段表以计算得到访问指令或数据的物理地址，然后才是对物理地址进行取数据或数据操作。为了提高访问速度，也可引入快表。

4. 存储共享
    只需在每个进程的段表中，由相应表项来指向该共享段在内存中的物理区即可。

分页和分段的主要区别

1. 页是信息的物理单位，分页仅仅是由于系统管理的需要，而不是用户的需要；而段是信息的逻辑单位，它含有一组具有相对完整意义的信息，是处于用户的需要。
2. 页的大小固定且由系统确定，把逻辑地址分为页号和页内地址两部分功能，由机器硬件实现；而段的长度却不固定，由用户在变成是确定，或由编译程序在对源程序进行编译时，根据信息的性质来划分。
3. 分页的作业地址空间是一维的，即单一的线性地址空间；而分段的作业地址空间则是二维的。


#### 段页式存储管理原理

分页系统能有效地提高内存利用率，而分段系统则能很好地满足用户需要，如果对两种存储管理方式“各取所长”，可结合成一种新的存储管理方式，它具有分段系统的优点，又能象分页系统那样很好地解决"碎片"问题。这个系统别称为"段页式系统"。

基本原理

段页式系统的基本原理是分段和分页原理的结合。先分段后分页，每段具有段名。

地址结构

段页式系统中，其地址结构由段名、段内页号和页内地址三部分组成

为实现地址映射，必须配置段表和页表，段表的内容略有变化，它不是内存始址和段长，而是页表始地址和页表长度。


在段页式系统中，为了获得一条指令或数据，需要三次访问内存。第一次，从内存中取得页表始址；第二次，从内存中取的物理块号形成物理地址；第三次才能取得所需的指令和数据。为了提高速度，必须引入超高速缓冲 Cache.
