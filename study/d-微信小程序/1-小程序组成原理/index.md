# 微信小程序

跨端的主要开发方向就是两个

- 虚拟机
    虚拟机提供了跨端执行代码的能力
    现在主流的js Engine就是苹果的JavaScriptCore和谷歌的V8
- 渲染引擎
    把跨端执行的代码计算所产生的用户数据通过渲染引擎处理，，最后是把相关图元信息通过各种图形 API（OpenGL/Metal/Vulkan/DirectX）发给 GPU 进行渲染

那么跨端开发就要解决这两个问题，小程序的跨端的虚拟机和渲染引擎如下

[小程序运行环境](/study/imgs/%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83.png)
## 快速拥有小程序能力的结构

- 打包成 native 语言，原生渲染  - uniapp拥有这样的能力
- webview方案，分成渲染层和逻辑层
  - 微信小程序就是这样的结构

## 双线程结构

![结构图](https://eux-public.bj.bcebos.com/2018/08/15/tgy-wx-k.jpg)

### 渲染层

渲染线程使用 Webview 进行 UI 的渲染呈现。Webview 是一个完整的类浏览器运行环境，本身具备运行 JavaScript 的能力，但是小程序并不是将逻辑脚本放到 Webview 中运行，而是将逻辑层独立为一个与 Webview 平行的线程，使用客户端提供的 JavaScript 引擎运行代码，iOS 的JavaScriptCore、安卓是腾讯 X5 内核提供的 JsCore 环境以及 IDE 工具的 nwjs 

### 逻辑层

逻辑线程是一个只能够运行 JavaScript 的沙箱环境，不提供 DOM 操作相关的 API，所以不能直接操作 UI，只能够通过 setData 更新数据的方式异步更新 UI。

### 事件驱动的通信方式

![事件驱动的通信方式](https://img2020.cnblogs.com/blog/595796/202105/595796-20210517181813421-1609752624.png)

注意上图渲染线程和逻辑线程之间的通信方式，与 Vue/React 不同的是，小程序的渲染层与逻辑层之间的通信并不是在两者之间直接传递数据或事件，而是由 Native 作为中间媒介进行转发。

整个过程是典型的事件驱动模式：

1. 渲染层（也可以称为视图层）通过与用户的交互触发特定的事件 event；

2. 然后 event 被传递给逻辑层；

3. 逻辑层继而通过一系列的逻辑处理、数据请求、接口调用等行为将加工好的数据 data 传递给渲染层；

4. 最后渲染层将 data 渲染为可视化的 UI。

### 网页plus： JS Engine + WebKit + Native 能力

JSBridge 只是解决了 Native 和 Web 的互相调用问题，如果我想借助 Native 加强 Web 怎么办？这时候就有了一些探索：

- 预热：提前创建和初始化 WebView，甚至实现 WebView 容器池，减少 WebView 的启动时间

- 缓存：把常用的 Web 资源预先存在 Native 本地，然后拦截浏览器网络请求重定向到本地，这样就可以加快 Web 的资源加载速度（也叫"离线包"方案）；

- 劫持：比如说 Web 对网络加载的控制力比较弱，部分有能力的厂商会把所有的网络请求都劫持下来交给 Native 去做，这样做可以更灵活的管理 Web 请求

- 替换：替换一般指替换 Web 的 Img 标签和 Video 标签，这个最常见的地方就是各大新闻类客户端。因为新闻的动态性和实时性，新闻都是由各个编辑/自媒体通过后台编辑下发的，这时候要利用 Web 强大的排版功能去显示文本内容；但是为了加载速度和观看体验，图片和视频都是 Native 组件替换的

经过上面几步，网页的速度基本可以达到秒开的级别

## 当前在一个app中快速有小程序能力的方案

- uni-sdk 
- FinClip
- mPaaS

## 产生独立思考

1. [webview](./webview.md)
   - 是否会无限的创建新的webview?
   - 如何销毁？创建的丝滑动画怎么产生？
   - 小程序如何快速打开一个页面渲染的？
   - 是否一个逻辑层对应一个ui层webview吗？  
2. [逻辑层和渲染层如何进行通讯？ 通讯哪些内容](./%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F.md)？
3. [小程序的组件是啥？为啥我们自己写个div不能被渲染](./%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.md)？
4. [小程序是否会解决白屏的问题?](./webview.md)
5. [小程序的事件处理流程是啥](./%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F.md)？
6. ["javascript脚本执行不会抢占ui渲染资源，使整体页面渲染更快；"这句话是否正确?在什么情况下正确？在实际开发中的场景它解决了什么问题，能有什么样的效果？有什么好处](./%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F.md)？
7. [微信为什么要这样的双线程设计？解决了什么问题？ 有什么挑战？ 和我们浏览器开发网页本质有啥不同？](./webview.md)
  