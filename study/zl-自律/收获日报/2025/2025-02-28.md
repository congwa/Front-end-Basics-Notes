# 2025-02-28

[一个简单的关系rag fast-graphrag](https://github.com/circlemind-ai/fast-graphrag)

- [ ] 嵌入流程是怎么样子的？

1. 对文本分块(可配置)， 过滤出增量的数据块
2. 使用 asyncio.gather 并行处理多个块， 喂给大模型，让大模型根据已经定义的类型提取跟类型相关的实体、然后提取实体之间关系 每个块生成一份实体和关系的json， josn合并，插入图数据库(创建新的图存储实例-初始化的时候已经读取了已存在的,顺序处理每个子图,使用 graph_upsert 处理冲突,确保实体和关系的一致性)
3. 合并多个图数据库，对相同实体的边进行分组，写入实体(实体超过512字符的时候使用llm压缩),使用llm合并相似的边映射，重新整理关系(更新，增删)
4. 实体嵌入向量数据库 实体去重，找出3个最相似的实体，创建 is关系的边插入
5. 把片段插入文档数据库
6. 维护 c2r(文本片段到关系) e2r(实体到关系) 的映射，方便以后召回

## 第二步： 提取的时候会agent循环

- 使用 LLM 从文本块提取实体和关系
- 保存对话历史以维持上下文
- 细化提取（Gleaning）：
- 反复询问 LLM 是否有遗漏的信息
- 累积收集新发现的实体和关系
- 直到 LLM 认为完成或达到最大迭代次数
- 一个文档会创建一个图数据，之后再把每个文档对应的图数据内容取出来，合并插入到一个大的图数据库中

## e2r

- 从图存储中获取实体-关系映射
- 返回一个稀疏矩阵，表示实体和关系之间的连接关系
- 矩阵形状：(#entities, #relationships)
- 用于后续从实体快速找到相关的关系

## c2r

- 从关系属性中获取关联的文本块ID
- 将文本块ID转换为系统内部索引
- 构建稀疏矩阵表示关系-文本块的连接关系
- 矩阵形状：(#relationships, #chunks)
- _merge_similar_edges 在合并边的时候，同时把所有的文本块id存入属性中

如上所示： 类型 -> 提取类型相关实体 -> 实体之间的关系 -> 文本块      (根据关系才能找到文本块)
